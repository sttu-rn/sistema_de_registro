<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Acesso STTU</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #2c3e50; margin: 0; }
        
        .container-box { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; }
        
        h2 { color: #333; margin-bottom: 5px; }
        p { color: #777; font-size: 13px; margin-bottom: 20px; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .uppercase { text-transform: uppercase; } /* Só para campos de texto */
        
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 15px; font-size: 14px; transition: 0.3s; }
        
        /* Botões Principais */
        .btn-verde { background-color: #27ae60; color: white; }
        .btn-verde:hover { background-color: #219150; }
        
        .btn-azul { background-color: #2980b9; color: white; }
        .btn-azul:hover { background-color: #3498db; }

        /* Links de Troca */
        .toggle-link { margin-top: 20px; display: block; font-size: 13px; color: #555; text-decoration: none; cursor: pointer; }
        .toggle-link:hover { text-decoration: underline; color: #000; }
        .toggle-link b { color: #2980b9; }

        .error { color: #c0392b; font-size: 12px; margin-top: 10px; display: none; background: #fadbd8; padding: 5px; border-radius: 3px; }

        /* Classes para esconder/mostrar */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container-box">
        
        <div id="telaLogin">
            <h2>Acesso Restrito</h2>
            <p>Identifique-se para acessar o sistema.</p>

            <input type="text" id="loginUser" placeholder="MATRÍCULA OU USUÁRIO" class="uppercase">
            <input type="password" id="loginPass" placeholder="SENHA">
            
            <button class="btn-verde" id="btnEntrar">ENTRAR NO SISTEMA</button>
            
            <div id="msgErroLogin" class="error"></div>

            <a class="toggle-link" id="linkIrCadastro">
                Não tem acesso? <b>Criar novo usuário</b>
            </a>
        </div>

        <div id="telaCadastro" class="hidden">
            <h2>Solicitar Acesso</h2>
            <p>Preencha para pedir autorização ao administrador.</p>

            <input type="text" id="cadNome" placeholder="NOME COMPLETO" class="uppercase">
            <input type="text" id="cadMatricula" placeholder="MATRÍCULA (SERÁ SEU LOGIN)" class="uppercase">
            <input type="password" id="cadSenha" placeholder="CRIE UMA SENHA">
            
            <button class="btn-azul" id="btnCadastrar">SOLICITAR CADASTRO</button>
            
            <div id="msgErroCad" class="error"></div>

            <a class="toggle-link" id="linkIrLogin">
                Já tem conta? <b>Voltar para o Login</b>
            </a>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCjiEzdahcQqKS9V1Py4nAIx15Zqr9nIIo",
            authDomain: "sttu-registros.firebaseapp.com",
            projectId: "sttu-registros",
            storageBucket: "sttu-registros.firebasestorage.app",
            messagingSenderId: "785219239564",
            appId: "1:785219239564:web:4b8175a8d7ccceba06c5a9",
            measurementId: "G-C7PSE7YFRG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA DE TROCA DE TELA (Esconde um, mostra outro) ---
        document.getElementById('linkIrCadastro').onclick = () => {
            document.getElementById('telaLogin').classList.add('hidden');
            document.getElementById('telaCadastro').classList.remove('hidden');
            limparErros();
        };

        document.getElementById('linkIrLogin').onclick = () => {
            document.getElementById('telaCadastro').classList.add('hidden');
            document.getElementById('telaLogin').classList.remove('hidden');
            limparErros();
        };

        function limparErros() {
            document.getElementById('msgErroLogin').style.display = 'none';
            document.getElementById('msgErroCad').style.display = 'none';
        }

        // --- LÓGICA DO LOGIN (ENTRAR) ---
        document.getElementById('btnEntrar').onclick = () => {
            const entrada = document.getElementById('loginUser').value.trim();
            const senha = document.getElementById('loginPass').value;
            const msg = document.getElementById('msgErroLogin');

            msg.style.display = 'none';

            if(!entrada || !senha) {
                msg.innerText = "Preencha usuário e senha.";
                msg.style.display = 'block';
                return;
            }

            // Truque do @sttu.com
            let emailFinal = entrada.includes("@") ? entrada : entrada + "@sttu.com";

            signInWithEmailAndPassword(auth, emailFinal, senha)
                .then(() => {
                    window.location.href = "index.html";
                })
                .catch((error) => {
                    msg.style.display = 'block';
                    if(error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        msg.innerText = "Dados incorretos.";
                    } else {
                        msg.innerText = "Erro: " + error.code;
                    }
                });
        };

        // --- LÓGICA DO CADASTRO (NOVO USUÁRIO) ---
        document.getElementById('btnCadastrar').onclick = async () => {
            const nome = document.getElementById('cadNome').value.trim().toUpperCase();
            const matricula = document.getElementById('cadMatricula').value.trim();
            const senha = document.getElementById('cadSenha').value;
            const msg = document.getElementById('msgErroCad');

            msg.style.display = 'none';

            if(!nome || !matricula || !senha) {
                msg.innerText = "Preencha todos os campos.";
                msg.style.display = 'block';
                return;
            }

            if(senha.length < 6) {
                msg.innerText = "Senha muito curta (mínimo 6).";
                msg.style.display = 'block';
                return;
            }

            const emailFake = matricula + "@sttu.com";

            try {
                // 1. Criar Auth
                const userCredential = await createUserWithEmailAndPassword(auth, emailFake, senha);
                const user = userCredential.user;

                // 2. Salvar no Banco (PENDENTE)
                await setDoc(doc(db, "usuarios", user.uid), {
                    nome: nome,
                    matricula: matricula,
                    cargo: "agente",
                    status: "pendente"
                });

                // 3. Deslogar e avisar
                await signOut(auth);
                alert("✅ Solicitação enviada!\n\nAguarde a aprovação do administrador para acessar.");
                
                // Volta para a tela de login automaticamente
                document.getElementById('linkIrLogin').click(); 

            } catch (error) {
                console.error(error);
                msg.style.display = 'block';
                if(error.code === 'auth/email-already-in-use') {
                    msg.innerText = "Usuário já cadastrado.";
                } else {
                    msg.innerText = "Erro: " + error.message;
                }
            }
        };

        // Permite dar Enter para enviar em ambos os formulários
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                if(!document.getElementById('telaLogin').classList.contains('hidden')) {
                    document.getElementById('btnEntrar').click();
                } else {
                    document.getElementById('btnCadastrar').click();
                }
            }
        });

    </script>
</body>
</html>
