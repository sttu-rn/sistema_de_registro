<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin - STTU</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #c0392b; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; color: white; transition: 0.3s; }
        
        .btn-salvar { background-color: #2c3e50; }
        .btn-salvar:hover { background-color: #34495e; }

        .btn-excluir { background-color: #c0392b; margin-top: 5px; }
        .btn-excluir:hover { background-color: #a93226; }

        .btn-voltar { background-color: #7f8c8d; margin-top: 20px; }

        .user-list { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .user-item { background: #fafafa; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .user-item:hover { background: #f1f1f1; border-color: #bbb; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; }
        .bg-admin { background-color: #c0392b; }
        .bg-agente { background-color: #27ae60; }
        .bg-visualizador { background-color: #f39c12; }

        /* Card do Contador */
        .card-contador { margin-top: 30px; padding: 20px; background: #fff8e1; border-left: 5px solid #f39c12; border-radius: 4px; }
        .btn-zerar { background-color: #e67e22; width: 100%; margin-top: 10px; padding: 10px; }
        .btn-zerar:hover { background-color: #d35400; }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚öôÔ∏è Gerenciar Usu√°rios</h1>
        
        <div class="form-group">
            <label>UID do Usu√°rio:</label>
            <input type="text" id="uidUser" placeholder="Selecione na lista abaixo..." readonly style="background-color: #eee;">
        </div>
        
        <div class="form-group">
            <label>Nome Completo:</label>
            <input type="text" id="nomeUser" style="text-transform: uppercase;">
        </div>

        <div class="form-group">
            <label>Matr√≠cula:</label>
            <input type="text" id="matUser">
        </div>

        <div class="form-group">
            <label>Cargo / Permiss√£o:</label>
            <select id="cargoUser">
                <option value="agente">AGENTE</option>
                <option value="admin">ADMINISTRADOR</option>
                <option value="visualizador">VISUALIZADOR</option>
            </select>
        </div>

        <button class="btn btn-salvar" id="btnSalvar">üíæ SALVAR ALTERA√á√ïES</button>
        <button class="btn btn-excluir" id="btnExcluir">üóëÔ∏è EXCLUIR USU√ÅRIO</button>

        <div class="user-list">
            <h3>Usu√°rios Cadastrados:</h3>
            <div id="listaUsuarios">Carregando...</div>
        </div>

        <div class="card-contador">
            <h3 style="margin-top:0; color:#e67e22;">üî¢ Controle Global de Ocorr√™ncias</h3>
            <p style="font-size:14px; color:#555;">Use este bot√£o apenas na virada do ano ou quando for necess√°rio reiniciar a numera√ß√£o para 001.</p>
            <button class="btn btn-zerar" id="btnZerarContador">ZERAR CONTADOR PARA 000</button>
        </div>

        <button class="btn btn-voltar" onclick="window.location.href='index.html'">VOLTAR AO IN√çCIO</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCjiEzdahcQqKS9V1Py4nAIx15Zqr9nIIo",
        authDomain: "sttu-registros.firebaseapp.com",
        projectId: "sttu-registros",
        storageBucket: "sttu-registros.firebasestorage.app",
        messagingSenderId: "785219239564",
        appId: "1:785219239564:web:4b8175a8d7ccceba06c5a9",
        measurementId: "G-C7PSE7YFRG"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- SEGURAN√áA + TIMER (30 min) ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const docRef = doc(db, "usuarios", user.uid);
                const docSnap = await getDoc(docRef);
                
                // 1. Verifica se √© Admin mesmo
                if (!docSnap.exists() || docSnap.data().cargo !== 'admin') {
                    alert("ACESSO NEGADO.");
                    window.location.href = "index.html";
                    return;
                }

                // 2. Timer de Inatividade (Mesmo para Admin)
                let tempoInatividade;
                const LIMITE_TEMPO = 30 * 60 * 1000; // 30 minutos

                const resetarTimer = () => {
                    clearTimeout(tempoInatividade);
                    tempoInatividade = setTimeout(() => {
                        alert("‚ö†Ô∏è Sess√£o de Admin encerrada por inatividade.");
                        signOut(auth).then(() => window.location.href = "login.html");
                    }, LIMITE_TEMPO);
                };

                window.onload = resetarTimer;
                document.onmousemove = resetarTimer;
                document.onkeypress = resetarTimer;
                document.onclick = resetarTimer;
                document.onscroll = resetarTimer;

            } catch (e) {
                console.error(e);
            }
        } else {
            window.location.href = "login.html";
        }
    });

    // --- FUN√á√ÉO PARA ZERAR CONTADOR GLOBAL ---
    document.getElementById('btnZerarContador').onclick = async () => {
        if(confirm("ATEN√á√ÉO: Isso reiniciar√° o contador de ocorr√™ncias para 001 para TODOS os usu√°rios do sistema.\n\nDeseja continuar?")) {
            try {
                // Seta o valor 'atual' como 0. A pr√≥xima ocorr√™ncia ser√° 0 + 1 = 1 (001).
                await setDoc(doc(db, "config", "contador"), { atual: 0 });
                alert("‚úÖ Contador reiniciado com sucesso!");
            } catch (e) {
                alert("Erro ao zerar: " + e.message);
            }
        }
    };

    // --- FUN√á√ÉO SALVAR/EDITAR ---
    document.getElementById('btnSalvar').onclick = async () => {
        const uid = document.getElementById('uidUser').value.trim();
        const nome = document.getElementById('nomeUser').value.trim().toUpperCase();
        const mat = document.getElementById('matUser').value.trim();
        const cargo = document.getElementById('cargoUser').value;

        if (!uid || !nome || !mat) return alert("Selecione um usu√°rio na lista primeiro.");

        try {
            await updateDoc(doc(db, "usuarios", uid), {
                nome: nome,
                matricula: mat,
                cargo: cargo
            });
            alert("‚úÖ Dados atualizados!");
            limparFormulario();
        } catch (error) {
            alert("Erro: " + error.message);
        }
    };

    // --- FUN√á√ÉO EXCLUIR ---
    document.getElementById('btnExcluir').onclick = async () => {
        const uid = document.getElementById('uidUser').value.trim();
        const nome = document.getElementById('nomeUser').value.trim();

        if (!uid) return alert("Selecione um usu√°rio na lista primeiro para excluir.");

        const confirmacao = confirm(`‚ö†Ô∏è TEM CERTEZA que deseja EXCLUIR o acesso de:\n\n${nome}?\n\nEssa a√ß√£o impedir√° o login deste usu√°rio imediatamente.`);
        
        if (confirmacao) {
            try {
                await deleteDoc(doc(db, "usuarios", uid));
                alert("üóëÔ∏è Usu√°rio removido do sistema com sucesso!");
                limparFormulario();
            } catch (error) {
                alert("Erro ao excluir: " + error.message);
            }
        }
    };

    function limparFormulario() {
        document.getElementById('uidUser').value = "";
        document.getElementById('nomeUser').value = "";
        document.getElementById('matUser').value = "";
        document.getElementById('cargoUser').value = "agente";
    }

    // --- LISTA COM BOT√ÉO DE APROVA√á√ÉO ---
    onSnapshot(collection(db, "usuarios"), (snapshot) => {
        const lista = document.getElementById('listaUsuarios');
        lista.innerHTML = "";

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const uid = docSnap.id;
            
            let corBadge = "bg-agente";
            if (data.cargo === "admin") corBadge = "bg-admin";
            if (data.cargo === "visualizador") corBadge = "bg-visualizador";

            // Se estiver pendente
            let statusHtml = "";
            let btnAprovar = "";
            let estiloItem = "";

            if (data.status === "pendente") {
                estiloItem = "border-left: 5px solid orange; background: #fffdf0;";
                statusHtml = `<span class="badge" style="background:orange; color:black; margin-right:5px;">PENDENTE</span>`;
                btnAprovar = `<button onclick="aprovarUsuario('${uid}')" style="margin-left:10px; padding:6px; background:#27ae60; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">‚úÖ APROVAR</button>`;
            } else {
                statusHtml = `<span class="badge" style="background:#2ecc71; margin-right:5px;">ATIVO</span>`;
            }

            const item = document.createElement('div');
            item.className = "user-item";
            if(estiloItem) item.style.cssText = estiloItem;

            item.innerHTML = `
                <div style="flex-grow:1;">
                    ${statusHtml} 
                    <strong>${data.nome || 'SEM NOME'}</strong> (${data.matricula || 'S/M'})
                    ${btnAprovar}
                    <br><span style="font-size:10px; color:#999;">UID: ${uid}</span>
                </div>
                <span class="badge ${corBadge}">${data.cargo ? data.cargo.toUpperCase() : 'AGENTE'}</span>
            `;
            
            // Ao clicar no item
            item.onclick = (e) => {
                if(e.target.tagName !== 'BUTTON') {
                    document.getElementById('uidUser').value = uid;
                    document.getElementById('nomeUser').value = data.nome || "";
                    document.getElementById('matUser').value = data.matricula || "";
                    document.getElementById('cargoUser').value = data.cargo || "agente";
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            item.style.cursor = "pointer";
            item.title = "Clique para editar ou excluir";

            lista.appendChild(item);
        });
    });

    // Fun√ß√£o Global para Aprovar
    window.aprovarUsuario = async (uid) => {
        if(confirm("Confirma a aprova√ß√£o deste usu√°rio?")) {
            try {
                const docRef = doc(db, "usuarios", uid);
                await updateDoc(docRef, { status: "aprovado" });
                alert("Usu√°rio Aprovado!");
            } catch (e) {
                alert("Erro: " + e.message);
            }
        }
    };
</script>

</body>
</html>
