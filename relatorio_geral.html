<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio Geral - STTU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f4f4; display: flex; flex-direction: column; align-items: center; padding: 30px; }
        .card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        p { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        
        .date-group { display: flex; gap: 10px; justify-content: space-between; margin-bottom: 20px; }
        .date-item { flex: 1; text-align: left; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; font-size: 12px; }
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; display: block; margin-bottom: 10px; text-decoration: none; }
        
        .btn-gerar { background-color: #c0392b; }
        .btn-gerar:hover { background-color: #a93226; }
        
        .btn-email { background-color: #2980b9; display: none; }
        .btn-email:hover { background-color: #2471a3; }

        .btn-voltar { background-color: #7f8c8d; margin-top: 10px; }

        .loading { display: none; color: #e67e22; font-weight: bold; margin-top: 15px; font-size: 13px; }
        .aviso-anexo { font-size: 11px; color: #d35400; background: #fae5d3; padding: 5px; border-radius: 4px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div class="card">
        <h1>üìë Relat√≥rio Detalhado</h1>
        <p>Gera PDF com hist√≥rico completo, incluindo hor√°rios de todas as altera√ß√µes.</p>

        <div class="date-group">
            <div class="date-item">
                <label>DE (In√≠cio):</label>
                <input type="date" id="dataInicio">
            </div>
            <div class="date-item">
                <label>AT√â (Fim):</label>
                <input type="date" id="dataFim">
            </div>
        </div>

        <button class="btn btn-gerar" id="btnGerarPDF">1¬∫ BAIXAR PDF COMPLETO</button>
        <div id="msgLoading" class="loading">‚è≥ Processando dias...</div>
        
        <div id="areaEmail" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; display: none;">
            <div class="aviso-anexo">‚ö†Ô∏è ATEN√á√ÉO: Ao abrir o e-mail, anexe o arquivo <b>PDF</b> que foi baixado.</div>
            <a id="btnEnviarEmail" class="btn btn-email" target="_blank">2¬∫ ENVIAR PARA COTTSTTU@GMAIL.COM</a>
        </div>

        <button class="btn btn-voltar" onclick="window.location.href='index.html'">VOLTAR AO IN√çCIO</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCjiEzdahcQqKS9V1Py4nAIx15Zqr9nIIo",
            authDomain: "sttu-registros.firebaseapp.com",
            projectId: "sttu-registros",
            storageBucket: "sttu-registros.firebasestorage.app",
            messagingSenderId: "785219239564",
            appId: "1:785219239564:web:4b8175a8d7ccceba06c5a9",
            measurementId: "G-C7PSE7YFRG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 1. COLE AQUI O C√ìDIGO DA SUA IMAGEM ---
        const imgData = "data:image/jpeg;base64,/9j/4AAQSkZJRgAB..."; // MANTENHA O SEU C√ìDIGO AQUI

        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('dataInicio').value = hoje;
        document.getElementById('dataFim').value = hoje;

        // --- SEGURAN√áA + TIMER (30 MIN) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const docRef = doc(db, "usuarios", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const dados = docSnap.data();
                        if (dados.cargo !== 'visualizador') {
                            let tempoInatividade;
                            const LIMITE_TEMPO = 30 * 60 * 1000; 
                            const resetarTimer = () => {
                                clearTimeout(tempoInatividade);
                                tempoInatividade = setTimeout(() => {
                                    alert("‚ö†Ô∏è Sess√£o encerrada por inatividade (30min).");
                                    signOut(auth).then(() => window.location.href = "login.html");
                                }, LIMITE_TEMPO);
                            };
                            window.onload = resetarTimer; document.onmousemove = resetarTimer; document.onkeypress = resetarTimer; document.onclick = resetarTimer; document.onscroll = resetarTimer;
                        }
                    } else {
                        alert("Erro de cadastro."); await signOut(auth); window.location.href = "login.html";
                    }
                } catch (error) { console.error("Erro:", error); }
            } else {
                window.location.href = "login.html";
            }
        });

        function formatarDataBR(dataISO) {
            const partes = dataISO.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        function getDatesInRange(startDate, endDate) {
            const date = new Date(startDate);
            const end = new Date(endDate);
            const dates = [];
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            end.setMinutes(end.getMinutes() + end.getTimezoneOffset());
            while (date <= end) {
                dates.push(new Date(date).toISOString().split('T')[0]);
                date.setDate(date.getDate() + 1);
            }
            return dates;
        }

        document.getElementById('btnGerarPDF').onclick = async () => {
            const dataIni = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            if(!dataIni || !dataFim) return alert("Selecione a data inicial e final.");
            if(dataIni > dataFim) return alert("A data inicial n√£o pode ser maior que a final.");

            document.getElementById('msgLoading').style.display = 'block';
            document.getElementById('btnGerarPDF').disabled = true;
            document.getElementById('areaEmail').style.display = 'none';

            const diasParaProcessar = getDatesInRange(dataIni, dataFim);
            const { jsPDF } = window.jspdf;
            
            if (imgData.length < 50 && !imgData.includes("base64")) {
                alert("‚ö†Ô∏è AVISO: O c√≥digo da imagem parece vazio. O PDF pode sair sem bras√£o.");
            }

            const doc = new jsPDF('l', 'mm', 'a4'); // Paisagem

            try {
                for (let i = 0; i < diasParaProcessar.length; i++) {
                    const diaAtualISO = diasParaProcessar[i];
                    const diaAtualBR = formatarDataBR(diaAtualISO);
                    
                    document.getElementById('msgLoading').innerText = `‚è≥ Processando dia ${diaAtualBR}...`;

                    if (i > 0) doc.addPage();

                    const startOfDay = new Date(diaAtualISO + "T00:00:00");
                    const endOfDay = new Date(diaAtualISO + "T23:59:59");

                    // 1. Ocorr√™ncias
                    const qOcorrencias = query(collection(db, "ocorrencias_sttu"), orderBy("timestamp", "desc"));
                    const snapOcorrencias = await getDocs(qOcorrencias);
                    const listaOcorrencias = [];
                    snapOcorrencias.forEach(doc => {
                        const d = doc.data();
                        if(d.timestamp) {
                            const dataDoc = d.timestamp.toDate();
                            if(dataDoc >= startOfDay && dataDoc <= endOfDay) listaOcorrencias.push(d);
                        }
                    });

                    // 2. Agentes
                    const qAgentes = query(collection(db, "historico_agentes"), where("dataRelatorio", "==", diaAtualBR));
                    const qAgentesAtivos = query(collection(db, "ativos_agentes"), where("dataRelatorio", "==", diaAtualBR));
                    const snapAgentes = await getDocs(qAgentes);
                    const snapAgentesAtivos = await getDocs(qAgentesAtivos);
                    let listaAgentes = [];
                    snapAgentes.forEach(doc => listaAgentes.push({ ...doc.data(), status: "ENCERRADO" }));
                    snapAgentesAtivos.forEach(doc => listaAgentes.push({ ...doc.data(), status: "EM OPERA√á√ÉO" }));

                    // 3. Observa√ß√µes
                    const qObs = query(collection(db, "observacoes_sttu"), orderBy("timestamp", "desc"));
                    const snapObs = await getDocs(qObs);
                    const listaObs = [];
                    snapObs.forEach(doc => {
                        const d = doc.data();
                        if(d.timestamp) {
                            const dataDoc = d.timestamp.toDate();
                            if(dataDoc >= startOfDay && dataDoc <= endOfDay) listaObs.push(d);
                        }
                    });

                    // --- CABE√áALHO ---
                    if (imgData.length > 50) {
                        try { doc.addImage(imgData, 'JPEG', 14, 10, 25, 25); } catch(e) { console.log(e); }
                    }

                    const larguraPagina = doc.internal.pageSize.width;
                    
                    doc.setFontSize(14); 
                    doc.setTextColor(44, 62, 80); 
                    doc.setFont("helvetica", "bold");
                    const titulo = "CENTRAL DE OPERA√á√ïES DE TR√ÇNSITO E TRANSPORTE - COTT";
                    doc.text(titulo, larguraPagina - 14, 20, { align: "right" });
                    
                    doc.setFontSize(10); 
                    doc.setTextColor(100); 
                    doc.setFont("helvetica", "normal");
                    doc.text(`DATA: ${diaAtualBR}`, larguraPagina - 14, 32, { align: "right" });
                    
                    doc.setDrawColor(200, 200, 200); 
                    doc.line(14, 38, larguraPagina - 14, 38); 

                    let finalY = 45;

                    // --- TABELA 1: AGENTES ---
                    doc.setFontSize(12); doc.setTextColor(0); doc.setFont("helvetica", "bold");
                    doc.text("1. CONTROLE DE AGENTES E FROTA", 14, finalY); finalY += 5;
                    if (listaAgentes.length > 0) {
                        const bodyAgentes = listaAgentes.map(a => [a.veiculo, a.agente.replace(/\n/g, ", "), a.horaInicio, a.horaFim || "---", a.zona, a.status]);
                        doc.autoTable({ 
                            startY: finalY, 
                            head: [['VTR', 'Equipe', 'In√≠cio', 'Fim', 'Regi√£o', 'Situa√ß√£o']], 
                            body: bodyAgentes, 
                            theme: 'grid', 
                            headStyles: { fillColor: [52, 73, 94] }, 
                            styles: { fontSize: 8 }, 
                            margin: { bottom: 40 } 
                        });
                        finalY = doc.lastAutoTable.finalY + 15;
                    } else { doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("(Sem registros)", 14, finalY + 5); finalY += 15; }

                    // --- TABELA 2: OCORR√äNCIAS COM LINHA DO TEMPO NO HIST√ìRICO ---
                    doc.setFontSize(12); doc.setFont("helvetica", "bold");
                    doc.text("2. OCORR√äNCIAS REGISTRADAS (HIST√ìRICO DETALHADO)", 14, finalY); finalY += 5;
                    
                    if (listaOcorrencias.length > 0) {
                        const bodyOc = listaOcorrencias.map(o => {
                            // --- CONSTRUTOR DA LINHA DO TEMPO ---
                            let listaHistorico = [];

                            // 1. Hora do Registro Inicial (Sempre o primeiro)
                            if (o.horaEnvio) {
                                listaHistorico.push(`[${o.horaEnvio}] REGISTRO INICIAL`);
                            }

                            // 2. Hist√≥rico de Altera√ß√µes (Vindos do banco)
                            if (o.historicoLogs && Array.isArray(o.historicoLogs)) {
                                o.historicoLogs.forEach(log => {
                                    // Limpa caracteres ilegais e adiciona √† lista
                                    listaHistorico.push(String(log).replace(/[^\x20-\x7E\xA0-\xFF]/g, ""));
                                });
                            }

                            // Junta tudo com quebra de linha
                            let historicoFinal = listaHistorico.length > 0 ? listaHistorico.join("\n") : "-";

                            return [
                                o.numRegistro || "-",
                                o.horaEnvio,
                                o.ocorrencia,
                                o.local,
                                o.equipe,
                                o.situacao,
                                historicoFinal, // COLUNA DE HIST√ìRICO COM HOR√ÅRIOS
                                o.resultadoFinal || ""
                            ];
                        });

                        doc.autoTable({ 
                            startY: finalY, 
                            head: [['N¬∫', 'Hora', 'Tipo', 'Local', 'VTR', 'Situa√ß√£o', 'HIST√ìRICO (HOR√ÅRIO E A√á√ÉO)', 'Resultado']], 
                            body: bodyOc, 
                            theme: 'grid', 
                            headStyles: { fillColor: [192, 57, 43] }, 
                            styles: { 
                                fontSize: 7, 
                                cellPadding: 2,
                                overflow: 'linebreak', 
                                font: "helvetica",
                                valign: 'top' // Alinha texto ao topo para facilitar leitura da lista
                            },
                            columnStyles: {
                                0: { cellWidth: 10 },
                                1: { cellWidth: 12 },
                                2: { cellWidth: 25 },
                                3: { cellWidth: 35 },
                                4: { cellWidth: 18 },
                                5: { cellWidth: 18 },
                                6: { cellWidth: 90 }, // Hist√≥rico bem largo para caber a linha do tempo
                                7: { cellWidth: 'auto' }
                            },
                            margin: { bottom: 40 } 
                        });
                        finalY = doc.lastAutoTable.finalY + 15;
                    } else { doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("(Sem registros)", 14, finalY + 5); finalY += 15; }

                    const pageHeight = doc.internal.pageSize.height;
                    if (finalY > pageHeight - 60) { doc.addPage(); finalY = 40; }
                    
                    // --- TABELA 3: OBSERVA√á√ïES ---
                    doc.setFontSize(12); doc.setFont("helvetica", "bold");
                    doc.text("3. LIVRO DE PLANT√ÉO", 14, finalY); finalY += 5;
                    if (listaObs.length > 0) {
                        const bodyObs = listaObs.map(obs => [new Date(obs.timestamp.seconds * 1000).toLocaleTimeString('pt-BR'), obs.texto]);
                        doc.autoTable({ startY: finalY, head: [['Hora', 'Descri√ß√£o']], body: bodyObs, theme: 'striped', headStyles: { fillColor: [127, 140, 141] }, columnStyles: { 0: { cellWidth: 20 } }, styles: { fontSize: 8 }, margin: { bottom: 40 } });
                    } else { doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("(Sem registros)", 14, finalY + 5); }

                    // Rodap√© (Assinaturas)
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let p = 1; p <= totalPages; p++) {
                        doc.setPage(p);
                        const footerY = pageHeight - 25;
                        doc.line(14, footerY - 5, larguraPagina - 14, footerY - 5);
                        doc.setFontSize(8); doc.setTextColor(0);
                        doc.setFont("helvetica", "bold");
                        doc.text("Carmozina R√©gia de Melo Dantas", 14, footerY + 5);
                        doc.setFont("helvetica", "normal");
                        doc.text("Respons√°vel pelo setor de atendimento da COTT", 14, footerY + 9);
                        doc.setFont("helvetica", "bold");
                        doc.text("Kleber Silvestre Lustosa", larguraPagina - 14, footerY + 5, { align: 'right' });
                        doc.setFont("helvetica", "normal");
                        doc.text("Inspetor da COTT", larguraPagina - 14, footerY + 9, { align: 'right' });
                    }
                }

                document.getElementById('msgLoading').innerText = "‚è≥ Finalizando PDF...";
                
                const nomeArquivo = dataIni === dataFim ? 
                    `Relatorio_STTU_${formatarDataBR(dataIni).replace(/\//g, '-')}.pdf` : 
                    `Relatorio_STTU_${formatarDataBR(dataIni).replace(/\//g, '-')}_a_${formatarDataBR(dataFim).replace(/\//g, '-')}.pdf`;
                
                doc.save(nomeArquivo);

                const assunto = `RELAT√ìRIO STTU - ${formatarDataBR(dataIni)} A ${formatarDataBR(dataFim)}`;
                const corpo = `Segue em anexo o relat√≥rio unificado (com hist√≥rico de encaminhamentos).\n\nAtt,\nEquipe STTU`;
                const linkGmail = `https://mail.google.com/mail/?view=cm&fs=1&to=cottsttu@gmail.com&su=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
                
                document.getElementById('btnEnviarEmail').href = linkGmail;
                document.getElementById('areaEmail').style.display = 'block';
                document.querySelector('.btn-email').style.display = 'block';
                document.querySelector('.aviso-anexo').style.display = 'block';

                alert("‚úÖ PDF Detalhado gerado com sucesso!");

            } catch (error) {
                console.error(error);
                alert("Erro ao gerar: " + error.message);
            } finally {
                document.getElementById('msgLoading').style.display = 'none';
                document.getElementById('btnGerarPDF').disabled = false;
            }
        };
    </script>
</body>
</html>
