<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio Oficial - STTU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f4f4; display: flex; flex-direction: column; align-items: center; padding: 30px; }
        .card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        p { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; text-align: left; }
        input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; margin-bottom: 20px; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; display: block; margin-bottom: 10px; text-decoration: none; }
        
        .btn-gerar { background-color: #c0392b; }
        .btn-gerar:hover { background-color: #a93226; }
        
        .btn-email { background-color: #2980b9; display: none; }
        .btn-email:hover { background-color: #2471a3; }

        .btn-voltar { background-color: #7f8c8d; margin-top: 10px; }

        .loading { display: none; color: #e67e22; font-weight: bold; margin-top: 15px; }
        .aviso-anexo { font-size: 11px; color: #d35400; background: #fae5d3; padding: 5px; border-radius: 4px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div class="card">
        <h1>üìë Relat√≥rio Oficial</h1>
        <p>Gera o PDF com timbre da STTU e assinaturas dos respons√°veis.</p>

        <label>Selecione a Data do Relat√≥rio:</label>
        <input type="date" id="dataRelatorio">

        <button class="btn btn-gerar" id="btnGerarPDF">1¬∫ BAIXAR PDF OFICIAL</button>
        <div id="msgLoading" class="loading">‚è≥ Processando dados...</div>
        
        <div id="areaEmail" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; display: none;">
            <div class="aviso-anexo">‚ö†Ô∏è ATEN√á√ÉO: Ao abrir o e-mail, n√£o esque√ßa de <b>ANEXAR O ARQUIVO PDF</b> que voc√™ acabou de baixar.</div>
            <a id="btnEnviarEmail" class="btn btn-email" target="_blank">2¬∫ ENVIAR PARA COTTSTTU@GMAIL.COM</a>
        </div>

        <button class="btn btn-voltar" onclick="window.location.href='index.html'">VOLTAR AO IN√çCIO</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCjiEzdahcQqKS9V1Py4nAIx15Zqr9nIIo",
            authDomain: "sttu-registros.firebaseapp.com",
            projectId: "sttu-registros",
            storageBucket: "sttu-registros.firebasestorage.app",
            messagingSenderId: "785219239564",
            appId: "1:785219239564:web:4b8175a8d7ccceba06c5a9",
            measurementId: "G-C7PSE7YFRG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Data de hoje padr√£o
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('dataRelatorio').value = hoje;

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
        });

        document.getElementById('btnGerarPDF').onclick = async () => {
            const dataInput = document.getElementById('dataRelatorio').value;
            if(!dataInput) return alert("Selecione uma data.");

            const partesData = dataInput.split('-');
            const dataFormatadaBR = `${partesData[2]}/${partesData[1]}/${partesData[0]}`;

            document.getElementById('msgLoading').style.display = 'block';
            document.getElementById('btnGerarPDF').disabled = true;
            document.getElementById('areaEmail').style.display = 'none';

            try {
                // 2. Busca Dados
                const startOfDay = new Date(dataInput + "T00:00:00");
                const endOfDay = new Date(dataInput + "T23:59:59");
                
                // Ocorr√™ncias
                const qOcorrencias = query(collection(db, "ocorrencias_sttu"), orderBy("timestamp", "desc"));
                const snapOcorrencias = await getDocs(qOcorrencias);
                const listaOcorrencias = [];
                snapOcorrencias.forEach(doc => {
                    const d = doc.data();
                    if(d.timestamp) {
                        const dataDoc = d.timestamp.toDate();
                        if(dataDoc >= startOfDay && dataDoc <= endOfDay) listaOcorrencias.push(d);
                    }
                });

                // Agentes
                const qAgentes = query(collection(db, "historico_agentes"), where("dataRelatorio", "==", dataFormatadaBR));
                const qAgentesAtivos = query(collection(db, "ativos_agentes"), where("dataRelatorio", "==", dataFormatadaBR));
                const snapAgentes = await getDocs(qAgentes);
                const snapAgentesAtivos = await getDocs(qAgentesAtivos);
                let listaAgentes = [];
                snapAgentes.forEach(doc => listaAgentes.push({ ...doc.data(), status: "ENCERRADO" }));
                snapAgentesAtivos.forEach(doc => listaAgentes.push({ ...doc.data(), status: "EM OPERA√á√ÉO" }));

                // Observa√ß√µes
                const qObs = query(collection(db, "observacoes_sttu"), orderBy("timestamp", "desc"));
                const snapObs = await getDocs(qObs);
                const listaObs = [];
                snapObs.forEach(doc => {
                    const d = doc.data();
                    if(d.timestamp) {
                        const dataDoc = d.timestamp.toDate();
                        if(dataDoc >= startOfDay && dataDoc <= endOfDay) listaObs.push(d);
                    }
                });

                // 3. Monta o PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;

                let finalY = 40; 

                // --- TABELA 1: AGENTES ---
                doc.setFontSize(12); doc.setTextColor(0); doc.setFont("helvetica", "bold");
                doc.text("1. CONTROLE DE AGENTES E FROTA", 14, finalY);
                finalY += 5;

                if (listaAgentes.length > 0) {
                    const bodyAgentes = listaAgentes.map(a => [a.veiculo, a.agente.replace(/\n/g, ", "), a.horaInicio, a.horaFim || "---", a.zona, a.status]);
                    doc.autoTable({
                        startY: finalY,
                        head: [['VTR', 'Equipe', 'In√≠cio', 'Fim', 'Regi√£o', 'Situa√ß√£o']],
                        body: bodyAgentes,
                        theme: 'grid',
                        headStyles: { fillColor: [52, 73, 94] },
                        styles: { fontSize: 8 },
                        margin: { top: 40, bottom: 40 }
                    });
                    finalY = doc.lastAutoTable.finalY + 15;
                } else {
                    doc.setFontSize(10); doc.setFont("helvetica", "normal");
                    doc.text("(Sem registros)", 14, finalY + 5); finalY += 15;
                }

                // --- TABELA 2: OCORR√äNCIAS ---
                doc.setFontSize(12); doc.setFont("helvetica", "bold");
                doc.text("2. OCORR√äNCIAS REGISTRADAS", 14, finalY); finalY += 5;
                if (listaOcorrencias.length > 0) {
                    const bodyOc = listaOcorrencias.map(o => [o.numRegistro || "-", o.horaEnvio, o.ocorrencia, o.local, o.equipe, o.situacao, o.resultadoFinal || ""]);
                    doc.autoTable({
                        startY: finalY,
                        head: [['N¬∫', 'Hora', 'Tipo', 'Local', 'VTR', 'Situa√ß√£o', 'Resultado']],
                        body: bodyOc,
                        theme: 'grid',
                        headStyles: { fillColor: [192, 57, 43] },
                        styles: { fontSize: 7 },
                        margin: { top: 40, bottom: 40 }
                    });
                    finalY = doc.lastAutoTable.finalY + 15;
                } else { doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("(Sem registros)", 14, finalY + 5); finalY += 15; }

                // --- TABELA 3: OBSERVA√á√ïES ---
                if (finalY > pageHeight - 60) { doc.addPage(); finalY = 40; }
                
                doc.setFontSize(12); doc.setFont("helvetica", "bold");
                doc.text("3. LIVRO DE PLANT√ÉO", 14, finalY); finalY += 5;
                if (listaObs.length > 0) {
                    const bodyObs = listaObs.map(obs => [new Date(obs.timestamp.seconds * 1000).toLocaleTimeString('pt-BR'), obs.texto]);
                    doc.autoTable({
                        startY: finalY,
                        head: [['Hora', 'Descri√ß√£o']],
                        body: bodyObs,
                        theme: 'striped',
                        headStyles: { fillColor: [127, 140, 141] },
                        columnStyles: { 0: { cellWidth: 20 } },
                        styles: { fontSize: 8 },
                        margin: { top: 40, bottom: 40 }
                    });
                } else { doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("(Sem registros)", 14, finalY + 5); }

                // --- ADICIONA CABE√áALHO E RODAP√â EM TODAS AS P√ÅGINAS ---
                const totalPages = doc.internal.getNumberOfPages();

                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);

                    // === CABE√áALHO (NOVO) ===
                    doc.setFontSize(14);
                    doc.setTextColor(44, 62, 80); // Azul escuro
                    doc.setFont("helvetica", "bold");
                    
                    // Texto centralizado e quebrado em duas linhas se precisar
                    // O splitTextToSize quebra o texto para caber em 180mm (largura da p√°gina - margens)
                    const titulo = "RELAT√ìRIO DE REGISTROS DA CENTRAL DE OPERA√á√ïES DE TR√ÇNSITO E TRANSPORTE";
                    const linhasTitulo = doc.splitTextToSize(titulo, 180);
                    
                    doc.text(linhasTitulo, 105, 15, { align: "center" });
                    
                    // Subt√≠tulo com a data
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.setFont("helvetica", "normal");
                    doc.text(`DATA: ${dataFormatadaBR}`, 105, 28, { align: "center" });
                    
                    // Linha separadora
                    doc.setDrawColor(200, 200, 200);
                    doc.line(14, 32, 196, 32); 

                    // === RODAP√â (ASSINATURAS) ===
                    const footerY = pageHeight - 25;
                    doc.line(14, footerY - 5, 196, footerY - 5);

                    doc.setFontSize(8);
                    doc.setTextColor(0);
                    
                    // Esquerda
                    doc.setFont("helvetica", "bold");
                    doc.text("Carmozina Dantas", 14, footerY + 5);
                    doc.setFont("helvetica", "normal");
                    doc.text("Respons√°vel pelo setor de atendimento da COTT", 14, footerY + 9);

                    // Direita
                    doc.setFont("helvetica", "bold");
                    doc.text("Kleber Silvestre Lustosa", 196, footerY + 5, { align: 'right' });
                    doc.setFont("helvetica", "normal");
                    doc.text("Inspetor da COTT", 196, footerY + 9, { align: 'right' });

                    // Pagina√ß√£o
                    doc.setFontSize(7);
                    doc.setTextColor(150);
                    doc.text(`P√°gina ${i} de ${totalPages}`, 105, pageHeight - 5, { align: "center" });
                }

                // Salvar
                doc.save(`Relatorio_STTU_${dataInput}.pdf`);

                // Preparar bot√£o de email
                const assunto = `RELAT√ìRIO STTU - ${dataFormatadaBR}`;
                const corpo = `Segue em anexo o relat√≥rio oficial do dia ${dataFormatadaBR}.\n\nAtt,\nEquipe STTU`;
                const linkGmail = `https://mail.google.com/mail/?view=cm&fs=1&to=cottsttu@gmail.com&su=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
                
                document.getElementById('btnEnviarEmail').href = linkGmail;
                document.getElementById('areaEmail').style.display = 'block';
                document.querySelector('.btn-email').style.display = 'block';
                document.querySelector('.aviso-anexo').style.display = 'block';

                alert("‚úÖ PDF Oficial Gerado!\n\nConfira o arquivo baixado com o t√≠tulo e as assinaturas.");

            } catch (error) {
                console.error(error);
                alert("Erro: " + error.message);
            } finally {
                document.getElementById('msgLoading').style.display = 'none';
                document.getElementById('btnGerarPDF').disabled = false;
            }
        };
    </script>
</body>
</html>
