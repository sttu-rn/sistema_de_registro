<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STTU - Observa√ß√µes</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .header-box { background-color: #2c3e50; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        
        .registros-container { border: 1px solid #ddd; padding: 15px; height: 350px; overflow-y: auto; background-color: #fafafa; margin-bottom: 30px; font-size: 13px; line-height: 1.6; color: #333; }
        .registro-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: flex-start; } 
        .timestamp { font-weight: bold; color: #7f8c8d; min-width: 130px; } 
        .texto-registro { flex-grow: 1; margin-right: 10px; white-space: pre-wrap; } 
        .status-devolvido { color: #d35400; font-weight: bold; display: block; margin-top: 5px; border-left: 3px solid #d35400; padding-left: 5px; }

        .config-turno { background: #2c3e50; color: white; padding: 10px; border-radius: 5px 5px 0 0; display: flex; align-items: center; justify-content: space-between; margin-top: 15px; }
        .grid-equipamentos { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; border: 2px solid #2c3e50; padding: 15px; border-radius: 0 0 5px 5px; margin-bottom: 5px; background: #fff; }
        
        .item-conferencia { 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            gap: 10px; 
            font-size: 12px; 
            font-weight: bold; 
            color: #2c3e50; 
            text-align: right; 
        }

        .item-conferencia input { width: 45px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }

        /* --- ESTILOS DE VALIDA√á√ÉO DOS ITENS --- */
        .input-pendente { border: 2px solid #e74c3c !important; background-color: #fadbd8; color: #c0392b; font-weight: bold; }
        .input-ok { border: 2px solid #27ae60 !important; background-color: #fff; color: #27ae60; font-weight: bold; }

        .grid-linhas { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #ecf0f1; border-left: 2px solid #2c3e50; border-right: 2px solid #2c3e50; margin-bottom: 0; }
        .btn-linha { flex: 1; min-width: 100px; padding: 8px; border: 1px solid #bdc3c7; background-color: #fff; color: #7f8c8d; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 12px; transition: all 0.2s; text-align: center; }
        .btn-linha:hover { opacity: 0.9; }
        .btn-linha.ok { background-color: #27ae60; color: white; border-color: #219150; }
        .btn-linha.nok { background-color: #c0392b; color: white; border-color: #a93226; }

        .outras-obs, .tentante-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 10px; box-sizing: border-box; font-family: inherit; }
        .tentante-input { min-height: 80px; resize: vertical; }

        .selecao-maleta { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; align-items: center; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }
        .btn-maleta { padding: 8px 12px; border: 1px solid #2c3e50; background-color: #ecf0f1; color: #2c3e50; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 12px; transition: all 0.2s; }
        .btn-maleta.selecionada { background-color: #1ae045; color: white; border-color: #1ae045; }

        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        .btn { border: none; padding: 10px 20px; font-size: 14px; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background 0.3s; color: white; }
        .btn-registrar { background-color: #27ae60; }
        .btn:disabled { background-color: #95a5a6 !important; cursor: not-allowed; opacity: 0.7; }
        .btn-entrega { background-color: #3498db; }
        .btn-baixa { background-color: #e67e22; font-size: 10px; padding: 4px 8px; white-space: nowrap; }
        .btn-baixa-falta { background-color: #c0392b; font-size: 10px; padding: 4px 8px; white-space: nowrap; }
        .btn-tentante { background-color: #2c3e50; margin-top: 10px; }
        .btn-remocao { background-color: #c0392b; }
        .btn-inspetor { background-color: #34495e; }
        .btn-geral { background-color: #7f8c8d; }
        .btn-cones { background-color: #d35400; }
        
        .footer-menu { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 900px; margin-top: 30px; flex-wrap: wrap; }
        .btn-nav { background-color: #34495e; color: white; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; font-size: 14px; transition: background 0.3s; text-align: center; flex: 1; min-width: 150px; }
        .btn-nav:hover { background-color: #2c3e50; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #c0392b; }
        .modal-footer { margin-top: 15px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancelar { background-color: #95a5a6; }

        .data-hoje { background: #3498db; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-right: 10px; }
        .btn-sair-topo { background-color: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; }
        
        #nomeUsuarioDisplay { font-size: 11px; color: #bdc3c7; font-weight: bold; margin-right: 10px; }

        .area-operadoras { background: #fff; padding: 10px; border-left: 2px solid #2c3e50; border-right: 2px solid #2c3e50; border-bottom: 2px solid #2c3e50; }
        .titulo-operadora { font-size: 11px; font-weight: bold; color: #2c3e50; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-box">
            <h1 class="header-title">Observa√ß√µes - STTU</h1>
            <div style="display: flex; align-items: center;">
                <span id="nomeUsuarioDisplay">...</span>
                <span id="displayData" class="data-hoje">--/--/----</span>
                <button id="btnSair" class="btn-sair-topo">SAIR</button>
            </div>
        </div>

        <div class="registros-container" id="lista-registros">
            <em>Carregando hist√≥rico de hoje...</em>
        </div>

        <div class="input-section">
            <div class="config-turno">
                <strong>SERVI√áO INICIADO NA CENTRAL TURNO:</strong>
                <select id="turno-select">
                    <option value="SELECIONE">SELECIONE</option>
                    <option value="MATUTINO">MATUTINO</option>
                    <option value="VESPERTINO">VESPERTINO</option>
                    <option value="NOTURNO">NOTURNO</option>
                    <option value="MADRUGADA">MADRUGADA</option>
                </select>
            </div>
            
            <div style="background: #fff; padding: 10px; border: 2px solid #2c3e50; border-top: none; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="agente-turno-nome" list="listaAgentes" placeholder="NOME COMPLETO DO AGENTE" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase;" autocomplete="off">
                <datalist id="listaAgentes"></datalist>
            </div>
            
            <div style="background: #2c3e50; color: #bdc3c7; font-size: 11px; padding: 0 10px; text-align: center; margin-top: 5px;">CLIQUE NOS N√öMEROS: VERDE = FUNCIONANDO | VERMELHO = INOPERANTE</div>
            <div class="grid-linhas">
                <button class="btn-linha" data-num="3232-1003">3232-1003</button>
                <button class="btn-linha" data-num="156">156</button>
                <button class="btn-linha" data-num="0800-281-4050">0800-281-4050</button>
                <button class="btn-linha" data-num="3232-4979">3232-4979</button>
                <button class="btn-linha" data-num="3232-9105">3232-9105</button>
                <button class="btn-linha" data-num="3232-9107">3232-9107</button>
                <button class="btn-linha" data-num="98870-3862">98870-3862</button>
            </div>

            <div class="area-operadoras">
                <span class="titulo-operadora">OPERADORAS (PREENCHIMENTO OBRIGAT√ìRIO):</span>
                <div style="display: flex; gap: 10px;">
                    <textarea id="texto-operadora" class="tentante-input" style="margin-top: 0; min-height: 50px;" placeholder="TIM / OI / VIVO / CLARO" autocomplete="off"></textarea>
                </div>
            </div>

            <div class="grid-equipamentos" style="border-top: none; border-radius: 0 0 5px 5px;">
                <div class="item-conferencia">CEL. ATENDIMENTO: <input type="number" id="qtd-cel-atend" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">FONTE CELULAR: <input type="number" id="qtd-fonte-cel" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">CABO CELULAR: <input type="number" id="qtd-cabo-cel" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">CEL. WHATS INST.: <input type="number" id="qtd-zap" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">R√ÅDIO M√ìVEL: <input type="number" id="qtd-radio-movel" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">IMPRESSORA: <input type="number" id="qtd-impressora" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">CONTROLE AR: <input type="number" id="qtd-ar" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">MALETA 4744: <input type="number" id="qtd-m4744" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">MALETA 4746: <input type="number" id="qtd-m4746" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">MALETA 4750: <input type="number" id="qtd-m4750" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">MALETA 4751: <input type="number" id="qtd-m4751" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">MALETA 4756: <input type="number" id="qtd-m4756" class="verificar-item input-pendente" value="0"></div>
                <div class="item-conferencia">R√ÅDIO FIXO: <input type="number" id="qtd-radio-fixo" class="verificar-item input-pendente" value="0"></div>
            </div>
            <div class="btn-group"><button class="btn btn-registrar" id="btn-registrar-inicio">REGISTRAR IN√çCIO DE TURNO</button></div>
            
            <div class="config-turno"><strong>EQUIPAMENTOS POR MALETA / OUTROS:</strong></div>
            <div class="grid-equipamentos">
                <div class="selecao-maleta" id="container-botoes-maleta">
                    <span>SELECIONAR MALETA:</span>
                    <button class="btn-maleta" data-id="4744">MALETA N¬∫ 4744</button>
                    <button class="btn-maleta" data-id="4746">MALETA N¬∫ 4746</button>
                    <button class="btn-maleta" data-id="4750">MALETA N¬∫ 4750</button>
                    <button class="btn-maleta" data-id="4751">MALETA N¬∫ 4751</button>
                    <button class="btn-maleta" data-id="4756">MALETA N¬∫ 4756</button>
                    <input type="hidden" id="maleta-selecionada" value="">
                </div>
                <div class="item-conferencia">ETIL√îMETRO: <input type="number" id="qtd-etil" value="1"></div>
                <div class="item-conferencia">PITEIRA: <input type="number" id="qtd-piteira" value="2"></div>
                <div class="item-conferencia">IMPRESSORA: <input type="number" id="qtd-impressora-maleta" value="1"></div>
                <div class="item-conferencia">CARREGADORES: <input type="number" id="qtd-carregadores" value="5"></div>
                <div class="item-conferencia">BOBINA: <input type="number" id="qtd-bobina" value="1"></div>
                <div class="item-conferencia">BOAT: <input type="number" id="qtd-boat" value="2"></div>
                <div class="item-conferencia">CERTIFICADO: <input type="number" id="qtd-certificado" value="2"></div>
                <div class="item-conferencia">TC: <input type="number" id="qtd-tc" value="2"></div>
                <div class="item-conferencia">MANUAL: <input type="number" id="qtd-manual" value="2"></div>
                
                <div style="grid-column: 1 / -1; margin-top: 10px;">
                    <label style="font-size: 11px; font-weight: bold; color: #555;">ENTREGUE PARA (OBRIGAT√ìRIO):</label>
                    <input type="text" id="entregue-para" class="outras-obs" placeholder="NOME DO AGENTE QUE RECEBEU..." style="margin-top: 2px; border-left: 4px solid #dc3545;" autocomplete="off">
                </div>
                <div style="grid-column: 1 / -1;"><input type="text" id="obs-extras" class="outras-obs" placeholder="Outras observa√ß√µes..." autocomplete="off"></div>
            </div>
            <div class="btn-group"><button class="btn btn-entrega" id="btn-registrar-maleta">REGISTRAR ENTREGA DE MALETA</button></div>

            <div class="config-turno"><strong>REGISTRO DE TENTANTES:</strong></div>
            <div style="border: 2px solid #2c3e50; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <textarea id="texto-tentante" class="tentante-input" placeholder="Digite aqui o registo do tentante..." autocomplete="off"></textarea>
                <div class="btn-group"><button class="btn btn-tentante" id="btn-registrar-tentante">REGISTRAR TENTANTE</button></div>
            </div>

            <div class="config-turno" style="background-color: #8e44ad;"><strong>AFASTAMENTOS / ATESTADOS:</strong></div>
            <div style="border: 2px solid #8e44ad; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <div style="margin-bottom: 10px;"><select id="afast-lista-agentes" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;"></select></div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="afast-nome" placeholder="Digite o nome..." style="flex: 2; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                    <input type="text" id="afast-local" placeholder="Local..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                    <select id="afast-status" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"><option value="SEM ATESTADO">N√ÉO</option><option value="COM ATESTADO">SIM</option></select>
                </div>
                <div class="btn-group"><button class="btn" id="btn-registrar-afastamento" style="background-color: #8e44ad;">REGISTRAR AFASTAMENTO</button></div>
            </div>

            <div class="config-turno" style="background-color: #c0392b;"><strong>VE√çCULOS REMOVIDOS:</strong></div>
            <div style="border: 2px solid #c0392b; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="text" id="rem-placa" placeholder="ABC-1234" style="flex: 1; min-width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase;" autocomplete="off">
                    <input type="text" id="rem-equipe" placeholder="VTR..." style="flex: 1; min-width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase;" autocomplete="off">
                    <input type="text" id="rem-local" placeholder="Ex: Av. Rio Branco, 14h" style="flex: 2; min-width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                    <input type="text" id="rem-motivo" placeholder="Ex: Estac. Cal√ßada" style="flex: 2; min-width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                    <input type="text" id="rem-ait" placeholder="N¬∫ AIT" style="flex: 1; min-width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                    <input type="text" id="rem-trv" placeholder="N¬∫ TRV" style="flex: 1; min-width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                </div>
                <div class="btn-group"><button class="btn btn-remocao" id="btn-registrar-remocao">REGISTRAR REMO√á√ÉO</button></div>
            </div>

            <div class="config-turno" style="background-color: #34495e;"><strong>RELATO DO INSPETOR:</strong></div>
            <div style="border: 2px solid #34495e; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <textarea id="texto-inspetor" class="tentante-input" placeholder="Digite aqui o relato do inspetor..." style="margin-top: 0;" autocomplete="off"></textarea>
                <div class="btn-group" style="margin-top: 10px;"><button class="btn btn-inspetor" id="btn-registrar-inspetor">REGISTRAR RELATO</button></div>
            </div>

            <div class="config-turno" style="background-color: #7f8c8d;"><strong>OBSERVA√á√ïES GERAIS:</strong></div>
            <div style="border: 2px solid #7f8c8d; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <textarea id="texto-obs-geral" class="tentante-input" placeholder="Relate aqui as ocorr√™ncias gerais do dia..." autocomplete="off"></textarea>
                <div class="btn-group"><button class="btn btn-geral" id="btn-registrar-obs-geral">REGISTRAR OBSERVA√á√ÉO</button></div>
            </div>

            <div class="config-turno" style="background-color: #d35400;">
                <strong>CONTROLE DE CONES:</strong>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 11px;">TOTAL NO VIATURA/BASE:</span>
                    <input type="number" id="total-cones-geral" value="0" style="width: 60px; padding: 4px; border-radius: 4px; border: none; text-align: center; font-weight: bold; color: #d35400;">
                </div>
            </div>
            <div style="border: 2px solid #d35400; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: flex-end;">
                    
                    <div style="flex: 1; min-width: 80px;">
                        <label style="font-size: 10px; font-weight: bold; color: #555; display: block;">EQUIPE</label>
                        <select id="cone-equipe" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">...</option>
                            <option value="VT 01">VT 01</option>
                            <option value="VT 02">VT 02</option>
                            <option value="VT 03">VT 03</option>
                            <option value="VT 04">VT 04</option>
                            <option value="VT 05">VT 05</option>
                            <option value="VT 06">VT 06</option>
                            <option value="VT 07">VT 07</option>
                            <option value="VT 08">VT 08</option>
                            <option value="VT 09">VT 09</option>
                            <option value="VT 10">VT 10</option>
                            <option value="VT 11">VT 11</option>
                            <option value="VT 12">VT 12</option>
                            <option value="VT 13">VT 13</option>
                            <option value="VT 14">VT 14</option>
                            <option value="VT 15">VT 15</option>
                            <option value="VT 16">VT 16</option>
                            <option value="GUINCHO">GUINCHO</option>
                            <option value="SEMAF√ìRICA">SEMAF√ìRICA</option>
                        </select>
                    </div>

                    <div style="flex: 2; min-width: 120px;">
                        <label style="font-size: 10px; font-weight: bold; color: #555; display: block;">LOCAL</label>
                        <input type="text" id="cone-local" placeholder="Local..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" autocomplete="off">
                    </div>

                    <div style="flex: 1; min-width: 80px;">
                        <label style="font-size: 10px; font-weight: bold; color: #c0392b; display: block; text-align: center;">COLOCADOS (-)</label>
                        <input type="number" id="cone-colocado" placeholder="0" style="width: 100%; padding: 8px; border: 2px solid #c0392b; border-radius: 4px; text-align: center; font-weight: bold;">
                    </div>

                    <div style="flex: 1; min-width: 80px;">
                        <label style="font-size: 10px; font-weight: bold; color: #27ae60; display: block; text-align: center;">RECOLHIDOS (+)</label>
                        <input type="number" id="cone-recolhido" placeholder="0" style="width: 100%; padding: 8px; border: 2px solid #27ae60; border-radius: 4px; text-align: center; font-weight: bold;">
                    </div>

                    <div style="flex: 1; min-width: 80px;">
                        <label style="font-size: 10px; font-weight: bold; color: #555; display: block;">HORA FIM</label>
                        <input type="time" id="cone-hora-fim" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>

                </div>
                <input type="text" id="cone-obs" class="outras-obs" placeholder="Observa√ß√µes sobre os cones..." style="margin-top: 0; margin-bottom: 15px;" autocomplete="off">
                <div class="btn-group"><button class="btn btn-cones" id="btn-registrar-cones">REGISTRAR MOVIMENTA√á√ÉO DE CONES</button></div>
            </div>

            <div class="config-turno" style="background-color: #16a085;"><strong>EQUIPE COMPLEMENTAR:</strong></div>
            <div style="border: 2px solid #16a085; padding: 15px; border-radius: 0 0 5px 5px; background: #fff; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="comp-nome" placeholder="NOME" style="flex: 2; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase;" autocomplete="off">
                    <input type="text" id="comp-funcao" placeholder="FUN√á√ÉO..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase;" autocomplete="off">
                </div>
                <div class="btn-group"><button class="btn" id="btn-registrar-complementar" style="background-color: #16a085;">REGISTRAR EQUIPE</button></div>
            </div>

        </div> 
    </div> 
    
    <div class="footer-menu">
        <a href="index.html" class="btn-nav">P√ÅGINA INICIAL</a>
        <a href="agentes.html" class="btn-nav">AGENTES</a>
        <a href="ocorrencias.html" class="btn-nav">OCORR√äNCIAS</a>
        <a href="relatorio_geral.html" id="btnNavRelatorios" class="btn-nav" style="background-color: #8e44ad;">RELAT√ìRIOS</a>
    </div>

    <div id="modalDevolucao" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">DEVOLU√á√ÉO DE ITENS (INFORMAR QTD EXISTENTE)</div>
            <input type="hidden" id="id-devolucao-atual">
            <div class="grid-equipamentos" style="border:none; padding:0;">
                <div class="item-conferencia">ETIL√îMETRO: <input type="number" id="dev-etil" value="1"></div>
                <div class="item-conferencia">PITEIRA: <input type="number" id="dev-piteira" value="2"></div>
                <div class="item-conferencia">IMPRESSORA: <input type="number" id="dev-impressora" value="1"></div>
                <div class="item-conferencia">CARREGADORES: <input type="number" id="dev-carregadores" value="5"></div>
                <div class="item-conferencia">BOBINA: <input type="number" id="dev-bobina" value="1"></div>
                <div class="item-conferencia">BOAT: <input type="number" id="dev-boat" value="2"></div>
                <div class="item-conferencia">CERTIFICADO: <input type="number" id="dev-certificado" value="2"></div>
                <div class="item-conferencia">TC: <input type="number" id="dev-tc" value="2"></div>
                <div class="item-conferencia">MANUAL: <input type="number" id="dev-manual" value="2"></div>
            </div>
            <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="font-size: 12px; font-weight: bold; color: #c0392b;">QUEM CONFERIU A DEVOLU√á√ÉO?</label>
                <input type="text" id="dev-responsavel" placeholder="NOME DO AGENTE CONFERENTE" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase; margin-top: 5px;" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancelar" onclick="fecharModal()">CANCELAR</button>
                <button class="btn btn-baixa-falta" onclick="confirmarBaixaComFalta()">CONFIRMAR DEVOLU√á√ÉO</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, updateDoc, doc, serverTimestamp, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCjiEzdahcQqKS9V1Py4nAIx15Zqr9nIIo",
        authDomain: "sttu-registros.firebaseapp.com",
        projectId: "sttu-registros",
        storageBucket: "sttu-registros.firebasestorage.app",
        messagingSenderId: "785219239564",
        appId: "1:785219239564:web:4b8175a8d7ccceba06c5a9",
        measurementId: "G-C7PSE7YFRG"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const agentesDB = ["ADRIANA GOMES DA SILVA - 43.071-4", "ADRIANO ANDR√â GUEDES COSTA - 43.079-0", "ADRIANO NASCIMENTO DA FONSECA - 49.991-9", "AFR√ÇNIO MEDEIROS DA COSTA - 43.151-6", "AGRICIO BELCHIOR BANDEIRA NETO - 43.127-3", "AILTON ANDRADE - 62.095-5", "ALCINEIDE JUSTO SIQUEIRA - 62.100-5", "ALDREY LUIZ MORAIS DA SILVA - 62.549-3", "ALDRIN MAGNO DANTAS SIQUEIRA - 43.080-3", "ALESSANDRA DORA DA SILVA COSTA - 43.199-1", "ALEX SERAFIM DA SILVA - 15.231-5", "ALEXANDRA BARROS DO NASCIMENTO - 49.953-6", "ALEXANDRE DE SOUZA - 13.174-1", "ALEXANDRE MAGNO FREITAS COSMO - 61.947-7", "ALEXSANDRO NASCIMENTO BARBOSA - 43.072-2", "ALYENE PATRICIA CRUZ BRITO ALVES - 64.545-0", "ALISSON EMANOEL DE OLIVEIRA FAGUNDES - 49.995-1", "ALLAN ARA√öJO DE MEDEIROS - 43.073-1", "ANA MARIA DA SILVA ALVES - 13.141-5", "ANDERSON RODRIGO DO NASCIMENTO - 63.802-1", "ANDRE CORCINO DE LIMA FILHO - 00.387-5", "ANDREA CASTRO GALV√ÉO - 62.097-1", "ANDREIA CARLA SILVA FONSECA E SOUZA - 14.071-6", "ANDREZA CABRAL C√ÇMARA NUNES - 61.710-5", "ANNE CAROLINE MACEDO DE ARA√öJO - 60.233-7", "ANT√ÉO LOPES DE ARA√öJO FILHO - 43.100-1", "ANTONIO CLEMENTINO DA ROCHA - 13.632-8", "ANTONIO GUILHERME DOS SANTOS - 14.206-9", "ANTONIO SARMENTO RODRIGUES FILHO - 13.634-4", "BARBARA KALYANA DOS SANTOS GOMES - 43.102-8", "CARLOS EUBER DE FREITAS NEVES - 43.077-3", "CARLOS EUG√äNIO BARBOSA DE OLIVEIRA - 00.282-8", "CARLOS VALENTIM ALVES - 13.140-7", "CARLYLE C√ÇMARA DOS SANTOS - 43.150-8", "CARMOZINA REGIA DE MELO DANTAS - 43.084-6", "CAROLINA DE C√ÅSSIA DEFENTE - 43.101-0", "CASSIO CLAY PEREIRA - 14.190-9", "CASTRICIANO BRAZ DOS SANTOS - 13.593-3", "CHIARA LUCIA DE GUM√ÉO GON√áALVES COSTA - 43.096-0", "CLAUDIA JACQUELINE GALV√ÉO SOUZA - 14.937-3", "CLEIDE MARIA DOS SANTOS SILVA - 13.614-0", "CLEONEIDE CORREIA RAMALHO RIBEIRO - 13.609-3", "CRISTIANE DE MACEDO E SILVA - 62.873-5", "DANIEL ALBURQUERQUE EMERENCIANO GON√áALVES - 43.090-1", "DANIELLE PEREIRA DE OLIVEIRA - 60.072-5", "DANILSON BENTES MARINHO - 13.116-4", "DAVI FIRMINO DE LIMA - 14.953-5", "DEN√çLSON ARA√öJO DA COSTA - 60.090-3", "DIONISIO CARDOSO DA COSTA - 13.659-0", "DANILO CLAUDIO LIRA DOS SANTOS - 72.245-7", "ED√çLSON FERREIRA DOS SANTOS - 00.417-1", "EDILSON OLIVEIRA DA SILVA - 13.147-4", "EDINALVA DUARTE LEAL DE MEDEIROS - 00.463-4", "EDIN√ÅSIO COSTA SOARES - 49.986-2", "EDJA DE PAULA MAIA - 45.570-9", "EDSON RAIMUNDO DA SILVA - 13.463-5", "EDVALDO MANOEL DA SILVA - 00.465-1", "EDVALDO SOARES DA SILVA - 09.325-4", "ELIZABETE RANYELA MORAIS DE MOURA - 43.198-2", "ERNESTO MORAIS VIANA - 14.930-6", "EVALDO FELIX FERREIRA - 00.518-5", "EVERALDO ALEXANDRE FREIRE - 14.043-1", "FERNANDA FREITAS DE HOLANDA - 60.066-1", "FRANCISCO GILSON LEONIDAS DA SILVA - 13.679-4", "FRANZ BIAGGIO FULCO GAAG - 65.247-4", "GENALDO AZEVEDO TRINDADE - 43.086-2", "GILDIBERTO DE SOUZA ALVES - 08.646-1", "GILMAR GOMES DO NASCIMENTO - 06.726-1", "GUTEMBERG PEREIRA - 08.015-2", "HAILSON CABRAL DO NASCIMENTO - 00.375-1", "HARLLEY CAMPOS MARQUES - 65.420-5", "HEITOR RODRIGUES DE LIMA - 43.097-8", "HEMERSON MELO DA SILVA - 49.952-8", "HERANDY DE ARA√öJO CABRAL - 49.950-1", "HERQUILES LIMA DOS SANTOS - 43.149-4", "HEWERTON MOURA DA SILVA - 43.098-6", "ISABELA SILVA NIC√ÅCIO DE BRITO - 60.234-5", "ISRAEL FERREIRA PEREIRA - 13.110-5", "IVAN DE CARVALHO MEDEIROS - 00.431-6", "IVES SILVA DE SOUZA - 62.151-0", "JAIR JEFFERSON DE CARVALHO - 13.896-7", "JARDEL BEZERRA DE ANDRADE - 62.189-7", "JARDS MEDEIROS DE OLIVEIRA - 62.826-3", "JATSON FRANCISCO DA SILVA BANDEIRA - 13.727-8", "JEFFERSON STANLEY DA SILVA - 62.919-7", "JO√ÉO BATISTA MONTEIRO DE AQUINO - 00.482-1", "JO√ÉO BATISTA ROCHA FILHO - 49.994-3", "JO√ÉO BATISTA VARELA BARCA - 15.710-4", "JO√ÉO CLAUDIO OLIVEIRA DE FARIAS - 00.383-2", "JO√ÉO FERREIRA - 06.644-3", "JO√ÉO MARIA ALMEIDA DE MOURA - 43.070-6", "JO√ÉO MARIA MACEDO ROCHA - 43.201-6", "JO√ÉO PAULO DE OLIVEIRA - 43.082-0", "JO√ÉO WILLAMS DA SILVA - 62.253-2", "JONAS CRISTINO DA SILVA - 14.931-4", "JORGE LUIZ BARROS DO NASCIMENTO - 62.431-4", "JORGE LUIZ SIQUEIRA DE OLIVEIRA - 62.191-9", "JOS√â EUDES BEZERRA - 49.985-4", "JOS√â ALBERTO FREIRE DA COSTA - 42.766-7", "JOSE ALVES DE SOUZA NETO - 00.544-4", "JOSE AUTEMAR RICARDO - 00.475-8", "JOSE DINIZ RAMOS - 00.575-4", "JOSE EBER DA SILVA - 13.105-9", "JOS√â GON√áALVES MANGABEIRA DE MEDEIROS - 43.083-8", "JOS√â RICARDO GOMES CAVALCANTE - 13.102-4", "JOSE ROBERTO DA SILVA DE OLIVEIRA - 14.922-5", "JOS√â ROOSEVELT MEDEIROS J√öNIOR - 62.416-1", "JOSEMAR DA SILVA DAMASCENO - 60.068-7", "JOSEMAR TAVARES C√ÇMARA JUNIOR - 43.152-4", "JOSENILSON TEIXEIRA DE SOUZA - 00.386-7", "KASTEEN CARLOS DE AQUINO E SILVA - 43.076-5", "KLEBER SILVESTRE LUSTOSA - 49.825-4", "LAILTON RIBEIRO DA COSTA - 43.078-1", "LEONARDO BATISTA DE SOUZA SILVA - 64.542-7", "LEONARDO DA SILVEIRA LUCENA - 43.122-2", "MADSON LIMA CAVALCANTI DE OLIVEIRA - 49.989-7", "MANOEL NOBREGA DE OLIVEIRA - 13.758-8", "MARA LUCIA BARROS DE SOUZA - 70.665-5", "MARCELO BATISTA DE ANDRADE - 61.952-3", "MARCELO FRAN√áA DA SILVA - 60.073-3", "MARCELO ZAERDSON LINS MEDEIROS - 62.184-6", "MARCILIO DE OLIVEIRA RODRIGUES - 49.951-0", "M√ÅRCIO JOS√â DA SILVA - 68.159-8", "MARCOS ANTONIO DE OLIVEIRA - 07.326-1", "MARIA DE LOURDES DA SILVA FILHA - 43.200-8", "MARIA DO CARMO DA SILVA - 00.571-1", "MARIA DO SOCORRO LIMA MARTINS - 14.070-8", "MARIA DO SOCORRO SILVA DE ANDRADE - 14.114-3", "MARIA GORETE DUTRA DE OLIVEIRA - 13.988-2", "MARIA JANEIDE BEZERRA DA SILVA - 00.536-3", "MARIA SANTANA BORGES DA SILVA - 00.561-4", "MARIO JOSE DA SILVA LEMOS - 14.944-6", "MARISA GILVANEIDE BERTO - 00.538-0", "MARYANE CRISTINA LOPES PEREIRA - 43.112-5", "MAXIMIANO CAPIM DE MIRANDA - 13.462-7", "MAXWELL FERNANDES DA SILVA - 13.136-9", "MIGUEL √ÇNGELO DE SANTANA - 62.092-1", "MOISES PEREIRA DE ARAUJO - 08.229-5", "NADJANIA MARIA DAMASCENO VALLE - 62.368-7", "NAOMI SUASSUNA DOS SANTOS - 60.237-0", "NEUZELIDES PRISCILA SILVA ANDRADE - 49.949-8", "NEWDENBERG FERREIRA GALV√ÉO - 43.081-1", "NEWTON DE SOUZA PEREIRA FILHO - 60.064-4", "NUBIA SILENE DA SILVA COSTA - 14.109-7", "PATR√çCIA CRISTINA CAVALCANTE - 45.990-9", "RAIMUNDO NONATO DE MEDEIROS NETO - 00.249-6", "RAPHAELLE CAVALCANTE R. DE ARAUJO - 62.149-8", "RECIO RONALDO ANDRADE DE PAIVA - 09.532-0", "REGINA VIC√äNCIA CRISPIM - 62.250-8", "RICARDO SERGIO GOMES DA SILVA - 13.477-5", "RITA DE C√ÅSSIA SILVA - 49.992-7", "ROBSON LUIZ DE AZEVEDO - 00.184-8", "RODRIGO COSTA - 43.087-1", "ROGELIO FERNANDES DE MELO - 13.095-8", "RONALDO JORGE DA SILVA - 13.096-6", "RONALDO MARINHO DE SOUZA - 62.825-5", "RONALDO TEIXEIRA DE ARA√öJO - 62.257-5", "ROSEMBERG PEREIRA - 00.137-6", "SANDRA DA SILVA BEZERRIL BACELAR - 61.712-1", "SARAH POLYANA DIAS DOS SANTOS - 43.154-1", "SEVERINA SOARES NETA CARNEIRO - 00.327-1", "SEVERINO FERNANDES MAIA - 00.192-9", "SEVERINO SOLANO DA SILVA - 00.486-3", "SOLANO LOPES DANTAS - 00.663-7", "SYBELLE DE ARA√öJO DANTAS - 63.386-1", "TALITHA LOUISE FORTUNATO BEZERRA - 49.990-1", "THALES GALV√ÉO DE ARAUJO - 63.803-0", "THALLES THIAGO MEDEIROS DE SOUZA - 49.988-9", "THIAGO DE LIRA BEZERRA - 43.075-7", "THIAGO HENRIQUE FERREIRA DA SILVA - 60.275-2", "VALDELICE FERREIRA DE OLIVEIRA - 00.507-0", "VANESSA GALDINO DA SILVA - 61.955-8", "WALDICK GUERRA DE MEDEIROS - 13.281-1", "WALTER PEDRO DA SILVA - 00.358-1", "WANDERCLEY SILVA NEVES - 70.563-2", "WANDR√â WAGNER DA SILVA - 62.367-9", "ZELIO CUNHA - 13.400-7"];

    let nomeUsuarioLogado = "AN√îNIMO";
    let isVisualizador = false;

    // --- POPULATE AGENT LIST ON LOAD ---
    window.onload = () => {
        // 1. Populate the Select for "Afastamentos"
        const selectAfast = document.getElementById('afast-lista-agentes');
        selectAfast.innerHTML = '<option value="">-- SELECIONE NA LISTA --</option>';
        
        // 2. Populate the Datalist for "Inicio de Turno" (Autocomplete)
        const dataList = document.getElementById('listaAgentes');
        dataList.innerHTML = ''; // Clear previous options

        agentesDB.forEach(agente => {
            // For Select
            const optSelect = document.createElement('option');
            optSelect.value = agente;
            optSelect.innerText = agente;
            selectAfast.appendChild(optSelect);

            // For Datalist (Autocomplete)
            const optData = document.createElement('option');
            optData.value = agente;
            dataList.appendChild(optData);
        });

        // 3. Reset Turno Selector on Page Load (Anti-duplicate measure)
        document.getElementById('turno-select').value = "SELECIONE";
        const btn = document.getElementById('btn-registrar-inicio');
        btn.disabled = false;
        btn.innerText = "REGISTRAR IN√çCIO DE TURNO";
        btn.style.backgroundColor = "#27ae60";

        // --- NEW: Add event listeners to equipment inputs to handle verification state ---
        document.querySelectorAll('.verificar-item').forEach(el => {
            el.addEventListener('input', function() {
                // Remove 'input-pendente' and add 'input-ok' when user interacts
                this.classList.remove('input-pendente');
                this.classList.add('input-ok');
            });
        });
    };

    // --- RESET FUNCTION ---
    function resetarEquipamentos() {
        const ids = [
            'qtd-cel-atend', 'qtd-fonte-cel', 'qtd-cabo-cel', 'qtd-zap',
            'qtd-radio-movel', 'qtd-impressora', 'qtd-ar', 'qtd-m4744',
            'qtd-m4746', 'qtd-m4750', 'qtd-m4751', 'qtd-m4756', 'qtd-radio-fixo'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.value = "0";
            el.classList.remove('input-ok');
            el.classList.add('input-pendente');
        });
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const docRef = doc(db, "usuarios", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    
                    nomeUsuarioLogado = dados.nome || "Usu√°rio";
                    document.getElementById('nomeUsuarioDisplay').innerText = "OL√Å, " + nomeUsuarioLogado;

                    // --- TRAVA DE SEGURAN√áA: MODO VISUALIZADOR ---
                    // L√≥gica Unificada: Visualizador por Cargo OU por N√≠vel de Acesso
                    const nivel = dados.nivel_acesso || 'total';
                    const cargo = dados.cargo || '';
                    
                    // √â visualizador se: Nivel for leitura OU cargo for visualizador (e n√£o for admin)
                    isVisualizador = (nivel === 'leitura' || cargo === 'visualizador') && cargo !== 'admin';

                    if (isVisualizador) {
                        console.log("üîí MODO APENAS LEITURA ATIVADO (NUCLEAR)");
                        
                        // 1. DESTRUIR A √ÅREA DE INPUTS (N√£o apenas esconder)
                        const areaInputs = document.querySelector('.input-section');
                        if(areaInputs) areaInputs.remove();

                        // 2. DESTRUIR O MODAL
                        const areaModal = document.getElementById('modalDevolucao');
                        if(areaModal) areaModal.remove();

                        // 3. INJETAR CSS para garantir que bot√µes de tabela sumam
                        const style = document.createElement('style');
                        style.innerHTML = '.btn-baixa, .btn-baixa-falta { display: none !important; }';
                        document.head.appendChild(style);
                        
                        // 4. Desativa l√≥gica de salvar (caso sobre algo)
                        window.darBaixaNoFirebase = () => alert("Acesso Negado: Modo Visualizador.");
                        window.abrirModalFalta = () => alert("Acesso Negado: Modo Visualizador.");
                    }
                    // ----------------------------------------------

                    // --- NOVA L√ìGICA: OCULTAR RELAT√ìRIOS SE N√ÉO FOR ADMIN ---
                    if (dados.cargo !== 'admin') {
                        const btnRel = document.getElementById('btnNavRelatorios');
                        if (btnRel) btnRel.style.display = 'none';
                    }
                    // -------------------------------------------------------

                    if (dados.cargo !== 'visualizador') {
                        let tempoInatividade;
                        const LIMITE_TEMPO = 30 * 60 * 1000; 
                        const resetarTimer = () => {
                            clearTimeout(tempoInatividade);
                            tempoInatividade = setTimeout(() => {
                                alert("‚ö†Ô∏è Sess√£o encerrada por inatividade (30min).");
                                signOut(auth).then(() => window.location.href = "login.html");
                            }, LIMITE_TEMPO);
                        };
                        window.onload = resetarTimer; document.onmousemove = resetarTimer; document.onkeypress = resetarTimer; document.onclick = resetarTimer; document.onscroll = resetarTimer;
                    }
                } else {
                    alert("Erro de cadastro. Contate o suporte.");
                    await signOut(auth);
                    window.location.href = "login.html";
                }
            } catch (error) { console.error("Erro:", error); }
        } else {
            window.location.href = "login.html";
        }
    });

    const btnSair = document.getElementById('btnSair');
    if(btnSair) {
        btnSair.onclick = () => { signOut(auth).then(() => { window.location.href = "login.html"; }); }
    }

    function getDataHojeISO() {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    }
    function getDataHojeBR() {
        const hoje = new Date();
        return hoje.toLocaleDateString('pt-BR');
    }
    document.getElementById('displayData').innerText = "DATA: " + getDataHojeBR();

    const dataFiltro = getDataHojeISO();
    
    const q = query(
        collection(db, "observacoes_sttu"), 
        where("data_filtro", "==", dataFiltro)
    );

    onSnapshot(q, (snapshot) => {
        const lista = document.getElementById('lista-registros');
        lista.innerHTML = "";
        
        if (snapshot.empty) {
            lista.innerHTML = "<em>Nenhum registro encontrado para hoje.</em>";
            return;
        }

        let registros = [];
        snapshot.forEach(doc => { registros.push({ id: doc.id, ...doc.data() }); });

        registros.sort((a, b) => {
            const tA = a.timestamp ? a.timestamp.seconds : 0;
            const tB = b.timestamp ? b.timestamp.seconds : 0;
            return tB - tA; 
        });

        registros.forEach(data => {
            const id = data.id;
            const horaFormatada = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString('pt-BR') : "Processando...";
            
            const item = document.createElement('div');
            item.className = 'registro-item';
            
            let html = `
                <div class="timestamp">[${horaFormatada}]</div>
                <div class="texto-registro">
                    <span>${data.texto}</span>
                    ${data.baixa ? `<span class="status-devolvido">| DEVOLVIDO √ÄS ${data.baixa}</span>` : ""}
                </div>
            `;

            // S√≥ mostra bot√µes de baixa se N√ÉO for visualizador
            if (data.requerBaixa && !data.baixa && !isVisualizador) {
                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.flexDirection = 'column';
                btnContainer.style.gap = '5px';
                
                const btnBaixa = document.createElement('button');
                btnBaixa.className = 'btn btn-baixa';
                btnBaixa.innerText = 'DAR BAIXA / DEVOLVER';
                btnBaixa.onclick = () => window.darBaixaNoFirebase(id);
                
                const btnBaixaFalta = document.createElement('button');
                btnBaixaFalta.className = 'btn btn-baixa-falta';
                btnBaixaFalta.innerText = 'DEVOLVER C/ MATERIAIS EM FALTA';
                btnBaixaFalta.onclick = () => window.abrirModalFalta(id);

                btnContainer.appendChild(btnBaixa);
                btnContainer.appendChild(btnBaixaFalta);
                
                item.innerHTML = html;
                item.appendChild(btnContainer);
            } else {
                item.innerHTML = html;
            }
            
            lista.appendChild(item);
        });
    });

    async function salvarObservacao(texto, requerBaixa = false, extras = {}) {
        if (isVisualizador) return alert("Acesso Negado: Modo Visualizador.");

        try {
            const dados = {
                texto: texto.toUpperCase(),
                requerBaixa: requerBaixa,
                baixa: null,
                timestamp: serverTimestamp(),
                data_filtro: getDataHojeISO(), 
                ...extras
            };

            await addDoc(collection(db, "observacoes_sttu"), dados);
            registrarLogAuditoria("NOVA OBSERVA√á√ÉO", `Texto: "${texto.substring(0, 50)}..."`);

        } catch (e) {
            console.error("Erro ao salvar: ", e);
            alert("Erro ao conectar com o banco de dados.");
        }
    }

    async function registrarLogAuditoria(acao, detalhes) {
        if (isVisualizador) return; 
        try {
            await addDoc(collection(db, "logs_auditoria"), {
                usuario: nomeUsuarioLogado || "DESCONHECIDO",
                acao: acao.toUpperCase(),
                detalhes: detalhes,
                timestamp: serverTimestamp()
            });
        } catch (e) { console.error(e); }
    }

    window.darBaixaNoFirebase = async (idDoc) => {
        if (isVisualizador) return alert("Acesso Negado.");
        const conferente = prompt("POR FAVOR, DIGITE O NOME DO AGENTE QUE EST√Å CONFERINDO A DEVOLU√á√ÉO:");
        if (!conferente || conferente.trim() === "") return;

        const agora = new Date().toLocaleTimeString('pt-BR');
        const docRef = doc(db, "observacoes_sttu", idDoc);
        const docSnap = await getDoc(docRef);
        const textoComConferencia = docSnap.data().texto + ` | CONFERIDO POR: ${conferente.toUpperCase()}`;

        await updateDoc(docRef, { baixa: agora, texto: textoComConferencia });
        registrarLogAuditoria("BAIXA DE MATERIAL", `Item devolvido (ID: ${idDoc}). Conferido por: ${conferente}`);
    }

    window.abrirModalFalta = (id) => {
        if (isVisualizador) return alert("Acesso Negado.");
        document.getElementById('id-devolucao-atual').value = id;
        document.getElementById('modalDevolucao').style.display = 'flex';
    };
    window.fecharModal = () => document.getElementById('modalDevolucao').style.display = 'none';

    window.confirmarBaixaComFalta = async () => {
        if (isVisualizador) return alert("Acesso Negado.");
        const idDoc = document.getElementById('id-devolucao-atual').value;
        const conferente = document.getElementById('dev-responsavel').value.trim().toUpperCase();
        if (!conferente) return alert("Informe quem conferiu.");

        const agora = new Date().toLocaleTimeString('pt-BR');
        const docRef = doc(db, "observacoes_sttu", idDoc);
        
        // Coleta inputs do modal
        const etil = document.getElementById('dev-etil').value;
        const piteira = document.getElementById('dev-piteira').value;
        const imp = document.getElementById('dev-impressora').value;
        const car = document.getElementById('dev-carregadores').value;
        const bob = document.getElementById('dev-bobina').value;
        const boat = document.getElementById('dev-boat').value;
        const cert = document.getElementById('dev-certificado').value;
        const tc = document.getElementById('dev-tc').value;
        const manual = document.getElementById('dev-manual').value;

        const docSnap = await getDoc(docRef);
        const obsFalta = `\n[DEVOLU√á√ÉO C/ PEND√äNCIA: ETIL:${etil}, PITEIRA:${piteira}, IMP:${imp}, CARR:${car}, BOB:${bob}, BOAT:${boat}, CERT:${cert}, TC:${tc}, MAN:${manual}] | CONFERIDO POR: ${conferente}`;

        await updateDoc(docRef, { baixa: agora, texto: docSnap.data().texto + obsFalta });
        registrarLogAuditoria("BAIXA COM FALTA", `Item devolvido com pend√™ncias (ID: ${idDoc}). Conferido por: ${conferente}`);

        fecharModal();
    };

    document.querySelectorAll('.btn-linha').forEach(btn => {
        btn.onclick = () => {
            if (isVisualizador) return;
            if (btn.classList.contains('ok')) { btn.classList.remove('ok'); btn.classList.add('nok'); }
            else if (btn.classList.contains('nok')) { btn.classList.remove('nok'); }
            else { btn.classList.add('ok'); }
        };
    });

    document.getElementById('turno-select').addEventListener('change', async function() {
        if (isVisualizador) return;
        const turno = this.value;
        const btn = document.getElementById('btn-registrar-inicio');

        if (turno === "SELECIONE") {
            btn.disabled = false;
            btn.innerText = "REGISTRAR IN√çCIO DE TURNO";
            btn.style.backgroundColor = "#27ae60"; 
            return;
        }

        btn.disabled = true;
        btn.innerText = "VERIFICANDO DISPONIBILIDADE...";

        const qVerificacao = query(
            collection(db, "observacoes_sttu"), 
            where("tipo_registro", "==", "INICIO_TURNO"),
            where("data_controle", "==", getDataHojeISO()), 
            where("turno_controle", "==", turno)
        );

        const snapshot = await getDocs(qVerificacao);

        if (!snapshot.empty) {
            btn.innerText = `TURNO ${turno} J√Å REGISTRADO!`;
            btn.style.backgroundColor = "#95a5a6"; 
            btn.disabled = true;
        } else {
            btn.innerText = "REGISTRAR IN√çCIO DE TURNO";
            btn.style.backgroundColor = "#27ae60"; 
            btn.disabled = false;
        }
    });

    document.getElementById('btn-registrar-inicio').onclick = async () => {
        if (isVisualizador) return;
        const btn = document.getElementById('btn-registrar-inicio');
        btn.disabled = true;

        const turno = document.getElementById('turno-select').value;
        const nomeAgente = document.getElementById('agente-turno-nome').value.trim().toUpperCase();

        if (turno === "SELECIONE" || !nomeAgente) {
             alert("Preencha Turno e Nome do Agente.");
             btn.disabled = false; return;
        }

        const textoOperadora = document.getElementById('texto-operadora').value.trim();
        if (!textoOperadora) {
            alert("‚ö†Ô∏è √â obrigat√≥rio preencher a situa√ß√£o das OPERADORAS.");
            document.getElementById('texto-operadora').focus();
            btn.disabled = false; return;
        }

        const btnLinhas = document.querySelectorAll('.btn-linha');
        let todosTestados = true;
        btnLinhas.forEach(b => {
            if (!b.classList.contains('ok') && !b.classList.contains('nok')) { todosTestados = false; }
        });

        if (!todosTestados) {
            alert("‚ö†Ô∏è √â OBRIGAT√ìRIO verificar todos os n√∫meros de telefone.");
            btn.disabled = false; return;
        }

        const inputsEquip = document.querySelectorAll('.verificar-item');
        let equipPendente = false;
        inputsEquip.forEach(el => {
            if (el.classList.contains('input-pendente')) {
                equipPendente = true;
            }
        });

        if (equipPendente) {
            alert("‚ö†Ô∏è √â OBRIGAT√ìRIO conferir todos os itens (Os campos em VERMELHO devem ser clicados/modificados).");
            btn.disabled = false; return;
        }

        const qVerificacao = query(
            collection(db, "observacoes_sttu"), 
            where("tipo_registro", "==", "INICIO_TURNO"),
            where("data_controle", "==", getDataHojeISO()), 
            where("turno_controle", "==", turno)
        );
        const snapshot = await getDocs(qVerificacao);
        
        if (!snapshot.empty) {
            alert(`ERRO: O turno ${turno} j√° foi registrado!`);
            btn.innerText = `TURNO ${turno} J√Å REGISTRADO!`;
            btn.style.backgroundColor = "#95a5a6";
            return;
        }

        let statusLinhas = [];
        btnLinhas.forEach(b => {
            if (b.classList.contains('ok')) statusLinhas.push(`${b.getAttribute('data-num')}: OK`);
            else if (b.classList.contains('nok')) statusLinhas.push(`${b.getAttribute('data-num')}: INOPERANTE`);
        });
        const textoLinhas = statusLinhas.length > 0 ? ` | LINHAS: ${statusLinhas.join(', ')}` : "";

        const detalhes = `SERVI√áO INICIADO TURNO ${turno} - AGENTE: ${nomeAgente}${textoLinhas}. ` +
            `OPERADORAS: ${textoOperadora.toUpperCase()}. ` + 
            `CONFER√äNCIA: ` +
            `CEL.ATEND:${document.getElementById('qtd-cel-atend').value}, ` +
            `FONTE:${document.getElementById('qtd-fonte-cel').value}, ` +
            `CABO:${document.getElementById('qtd-cabo-cel').value}, ` +
            `ZAP:${document.getElementById('qtd-zap').value}, ` +
            `RAD.MOV:${document.getElementById('qtd-radio-movel').value}, ` +
            `IMP:${document.getElementById('qtd-impressora').value}, ` +
            `AR:${document.getElementById('qtd-ar').value}, ` +
            `M.4744:${document.getElementById('qtd-m4744').value}, ` +
            `M.4746:${document.getElementById('qtd-m4746').value}, ` +
            `M.4750:${document.getElementById('qtd-m4750').value}, ` +
            `M.4751:${document.getElementById('qtd-m4751').value}, ` +
            `M.4756:${document.getElementById('qtd-m4756').value}, ` +
            `RAD.FIX:${document.getElementById('qtd-radio-fixo').value}`;
        
        await salvarObservacao(detalhes, false, {
            tipo_registro: "INICIO_TURNO",
            data_controle: getDataHojeISO(),
            turno_controle: turno
        });
        
        registrarLogAuditoria("IN√çCIO DE TURNO", `Turno ${turno} iniciado por ${nomeAgente}`);
        alert("In√≠cio registrado com sucesso!");
        btn.innerText = "REGISTRADO COM SUCESSO";
        resetarEquipamentos();
        document.getElementById('texto-operadora').value = "";
    };

    document.getElementById('btn-registrar-maleta').onclick = async () => {
        if (isVisualizador) return;
        const nomeAgente = document.getElementById('agente-turno-nome').value.trim().toUpperCase();
        if (!nomeAgente) { alert("Preencha o Nome do Agente no topo primeiro."); window.scrollTo({ top: 0, behavior: 'smooth' }); return; }

        const maleta = document.getElementById('maleta-selecionada').value;
        
        // --- NOVA VALIDA√á√ÉO OBRIGAT√ìRIA ---
        const entreguePara = document.getElementById('entregue-para').value.trim().toUpperCase();
        if (!entreguePara) {
            alert("‚ö†Ô∏è CAMPO OBRIGAT√ìRIO: Informe para quem a maleta/item foi entregue.");
            document.getElementById('entregue-para').focus();
            return;
        }
        // ---------------------------------

        const obs = document.getElementById('obs-extras').value.trim();

        if (maleta) {
            const qCheck = query(collection(db, "observacoes_sttu"), 
                where("tipo_registro", "==", "ENTREGA_MALETA"),
                where("numero_maleta", "==", maleta),
                where("baixa", "==", null) 
            );
            const snapshot = await getDocs(qCheck);
            
            if (!snapshot.empty) {
                const docPreso = snapshot.docs[0];
                const confirmar = confirm(`ERRO: A maleta ${maleta} consta como EM USO por outro agente desde ${new Date(docPreso.data().timestamp.seconds * 1000).toLocaleString()}.\n\nDeseja FOR√áAR a devolu√ß√£o da anterior para liberar esta nova entrega?`);
                if (confirmar) {
                   await updateDoc(doc(db, "observacoes_sttu", docPreso.id), { 
                       baixa: new Date().toLocaleTimeString('pt-BR') + " (FOR√áADO)", 
                       texto: docPreso.data().texto + " | BAIXA FOR√áADA PELO SISTEMA PARA NOVA ENTREGA" 
                   });
                   alert("Registro anterior baixado. Tente registrar novamente agora.");
                   return;
                } else { return; }
            }
        }

        const qtdEtil = document.getElementById('qtd-etil').value;
        const qtdPiteira = document.getElementById('qtd-piteira').value;
        const qtdImp = document.getElementById('qtd-impressora-maleta').value;
        const qtdCar = document.getElementById('qtd-carregadores').value;
        const qtdBob = document.getElementById('qtd-bobina').value;
        const qtdBoat = document.getElementById('qtd-boat').value;
        const qtdCert = document.getElementById('qtd-certificado').value;
        const qtdTc = document.getElementById('qtd-tc').value;
        const qtdMan = document.getElementById('qtd-manual').value;

        const detalhes = `ENTREGA ${maleta ? 'DA MALETA '+maleta : 'DE EQUIPAMENTOS'}. ` +
            `RETIRADO POR: ${nomeAgente}. ` + 
            `ENTREGUE PARA: ${entreguePara}. ` + 
            `ITENS: ETIL:${qtdEtil}, PITEIRA:${qtdPiteira}, IMP:${qtdImp}, CARR:${qtdCar}, BOB:${qtdBob}, ` +
            `BOAT:${qtdBoat}, CERT:${qtdCert}, TC:${qtdTc}, MAN:${qtdMan} ${obs ? '| OBS: '+obs : ''}`;
        
        await salvarObservacao(detalhes, true, {
            tipo_registro: "ENTREGA_MALETA",
            numero_maleta: maleta || "OUTROS"
        });

        document.querySelectorAll('.btn-maleta').forEach(b => b.classList.remove('selecionada'));
        document.getElementById('maleta-selecionada').value = "";
        document.getElementById('obs-extras').value = "";
        document.getElementById('entregue-para').value = ""; // Limpa o campo
    };

    document.getElementById('btn-registrar-tentante').onclick = () => {
        if (isVisualizador) return;
        const campo = document.getElementById('texto-tentante');
        if (campo.value.trim()) { salvarObservacao(`REGISTRO DE TENTANTE: ${campo.value.trim()}`); campo.value = ""; }
    };

    document.getElementById('btn-registrar-afastamento').onclick = () => {
        if (isVisualizador) return;
        const nomeLista = document.getElementById('afast-lista-agentes').value;
        const nomeDigitado = document.getElementById('afast-nome').value.trim();
        const nomeFinal = nomeLista || nomeDigitado;
        const local = document.getElementById('afast-local').value.trim();
        const status = document.getElementById('afast-status').value;

        if (!nomeFinal) return alert("Informe o agente.");
        salvarObservacao(`AFASTAMENTO: AGENTE ${nomeFinal.toUpperCase()} - LOCAL: ${local.toUpperCase()} - SITUA√á√ÉO: ${status}`);
        document.getElementById('afast-lista-agentes').value = "";
        document.getElementById('afast-nome').value = "";
        document.getElementById('afast-local').value = "";
    };

    document.getElementById('btn-registrar-remocao').onclick = () => {
        if (isVisualizador) return;
        const placa = document.getElementById('rem-placa').value.trim().toUpperCase();
        const equipe = document.getElementById('rem-equipe').value.trim().toUpperCase();
        const local = document.getElementById('rem-local').value.trim().toUpperCase();
        const motivo = document.getElementById('rem-motivo').value.trim().toUpperCase();
        if (!placa || !motivo) return alert("Preencha Placa e Motivo.");
        salvarObservacao(`VE√çCULO REMOVIDO: PLACA ${placa} - EQUIPE: ${equipe} - LOCAL: ${local} - MOTIVO: ${motivo}`);
        document.getElementById('rem-placa').value = "";
        document.getElementById('rem-motivo').value = "";
    };

    document.getElementById('btn-registrar-inspetor').onclick = () => {
        if (isVisualizador) return;
        const relato = document.getElementById('texto-inspetor').value.trim();
        if (relato) { salvarObservacao(`RELATO DO INSPETOR: ${relato}`); document.getElementById('texto-inspetor').value = ""; }
    };

    document.getElementById('btn-registrar-obs-geral').onclick = () => {
        if (isVisualizador) return;
        const obs = document.getElementById('texto-obs-geral').value.trim();
        if (obs) { salvarObservacao(`OBSERVA√á√ÉO GERAL: ${obs}`); document.getElementById('texto-obs-geral').value = ""; }
    };

    document.getElementById('btn-registrar-cones').onclick = () => {
        if (isVisualizador) return;
        const equipe = document.getElementById('cone-equipe').value;
        const local = document.getElementById('cone-local').value.trim().toUpperCase();
        let col = parseInt(document.getElementById('cone-colocado').value) || 0;
        let rec = parseInt(document.getElementById('cone-recolhido').value) || 0;
        const obs = document.getElementById('cone-obs').value.trim().toUpperCase();
        
        let total = parseInt(document.getElementById('total-cones-geral').value) || 0;
        total = total - col + rec;
        document.getElementById('total-cones-geral').value = total;
        
        salvarObservacao(`CONTROLE DE CONES: ${equipe} - LOCAL: ${local} - COLOCADOS: ${col} - RECOLHIDOS: ${rec} - OBS: ${obs} - SALDO: ${total}`);
        document.getElementById('cone-local').value = "";
        document.getElementById('cone-colocado').value = "";
        document.getElementById('cone-recolhido').value = "";
        document.getElementById('cone-obs').value = "";
    };

    document.getElementById('btn-registrar-complementar').onclick = () => {
        if (isVisualizador) return;
        const nome = document.getElementById('comp-nome').value.trim().toUpperCase();
        const funcao = document.getElementById('comp-funcao').value.trim().toUpperCase();
        if (nome && funcao) {
            const textoFinal = `EQUIPE COMPLEMENTAR: AGENTE ${nome} - FUN√á√ÉO: ${funcao}`;
            salvarObservacao(textoFinal);
            document.getElementById('comp-nome').value = "";
            document.getElementById('comp-funcao').value = "";
        } else {
            alert("Preencha o nome e a fun√ß√£o!");
        }
    };

    document.querySelectorAll('.btn-maleta').forEach(botao => {
        botao.onclick = () => {
            const selecionada = botao.classList.contains('selecionada');
            document.querySelectorAll('.btn-maleta').forEach(b => b.classList.remove('selecionada'));
            if (!selecionada) {
                botao.classList.add('selecionada');
                document.getElementById('maleta-selecionada').value = botao.getAttribute('data-id');
            } else {
                document.getElementById('maleta-selecionada').value = "";
            }
        };
    });
</script>
</body>
</html>



