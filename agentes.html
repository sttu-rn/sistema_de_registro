<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Frota e Agentes - STTU</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        
        .page-header { background-color: #36454f; color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .title-container { font-size: 24px; font-weight: bold; }
        
        table { border-collapse: collapse; width: 100%; border: 1px solid #ddd; margin-bottom: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px; vertical-align: top; }
        .date-header-row { background-color: #36454f; color: white; text-align: center; font-weight: bold; }
        .data-header { background-color: #f2f2f2; text-align: center; font-weight: bold; }
        
        .agentes-container { display: flex; flex-direction: column; gap: 4px; min-width: 250px; }
        .agente-row { display: flex; align-items: center; gap: 5px; transition: opacity 0.3s; }
        
        .input-multiplo { margin-bottom: 2px; display: block; width: 98%; }

        input, select, textarea { 
            width: 98%; padding: 4px; box-sizing: border-box; border: 1px solid #ccc; 
            font-family: inherit; font-size: 11px; text-transform: uppercase; 
        }
        textarea { resize: vertical; min-height: 40px; }
        
        .condutor-radio { width: auto; cursor: pointer; }
        .obrigatorio { border-left: 4px solid #dc3545; }
        .campo-numerico { background-color: #fff9e6; font-weight: bold; }

        .section-title { background-color: #55606b; color: white; padding: 10px; margin-top: 30px; border-radius: 5px 5px 0 0; font-weight: bold; }
        
        #tabelaAtivos th { background-color: #ffc107; color: #212529; }
        #relatorioFinal th { background-color: #6a7c8b; color: white; }
        
        .hora-fim-celula { color: #d9534f; font-weight: bold; }
        .status-encaminhado { color: #e67e22; font-weight: bold; }
        .status-encerrado { color: #28a745; font-weight: bold; }
        .condutor-destaque { color: #007bff; font-weight: bold; }

        .btn { padding: 8px 12px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; transition: 0.3s; margin: 2px; }
        .btn-salvar { background-color: #007bff; color: white; }
        .btn-devolver { background-color: #dc3545; color: white; font-size: 10px; }
        .btn-encaminhar { background-color: #17a2b8; color: white; font-size: 10px; }
        .btn-confirmar { background-color: #28a745; color: white; font-size: 10px; }
        .btn-download { background-color: #28a745; color: white; }
        .btn-home { background-color: #55606b; color: white; text-decoration: none; display: inline-block; }
        .btn-sair { background-color: #c0392b; color: white; padding: 8px 15px; text-decoration: none; border-radius: 4px; font-size: 12px; cursor: pointer; border: none; }
        
        /* BOT√ÉO DE EXCLUIR (X) */
        .btn-excluir-x {
            background-color: #c0392b;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 3px;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-excluir-x:hover { background-color: #a93226; transform: scale(1.1); }

        input:disabled { background-color: #e9ecef; cursor: not-allowed; }
        .editando-celula { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; padding: 4px !important; }
        
        .edit-row-container { display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
        .edit-agente-input { width: 100% !important; font-size: 10px !important; background-color: white; }

        /* --- CORES DAS REGI√ïES --- */
        .regiao-1 { background-color: #3b364c !important; color: white; text-align: center; font-weight: bold; } 
        .regiao-2 { background-color: #e4f001 !important; color: white; text-align: center; font-weight: bold; } 
        .regiao-3 { background-color: #64ec02 !important; color: white; text-align: center; font-weight: bold; } 
        .regiao-4 { background-color: #096acc !important; color: white; text-align: center; font-weight: bold; } 
        .regiao-5 { background-color: #d30000 !important; color: black; text-align: center; font-weight: bold; } 
        .regiao-geral { background-color: #f8f9fa !important; color: #333; text-align: center; font-weight: bold; } 
    </style>
</head>
<body>

<div class="page-header">
    <div class="title-container">CONTROLE DE AGENTES E VE√çCULOS</div>
    <div id="userInfo" style="font-size: 12px; display: flex; align-items: center; gap: 10px;">
        <span id="nomeUsuarioDisplay" style="font-weight: bold; color: #ecf0f1;">Carregando...</span>
        <button id="btnSair" class="btn-sair">SAIR</button>
    </div>
</div>

<div style="padding: 0 20px;">
    <div id="areaRegistro">
        <form id="registroForm" autocomplete="off">
            <table>
                <thead>
                    <tr>
                        <th class="date-header-row" colspan="9">INFORMA√á√ïES GERAIS</th>
                    </tr>
                    <tr>
                        <td class="date-header-row" colspan="4" id="diaSemana">---</td>
                        <td class="date-header-row" colspan="5"><input type="text" id="dataRelatorio" style="background:transparent; color:white; text-align:center; border:none;" readonly></td>
                    </tr>
                    <tr id="headerOriginalRow">
                        <th class="data-header">VE√çCULO E LOCAL</th>
                        <th class="data-header">AGENTES E CONDUTOR (‚¶ø)</th>
                        <th class="data-header">HT (N¬∫)</th>
                        <th class="data-header">ASE (N¬∫)</th>
                        <th class="data-header">FUN√á√ÉO EQUIPE</th>
                        <th class="data-header">MALETAS (N¬∫)</th>
                        <th class="data-header">REGI√ÉO ATUAL</th>
                        <th class="data-header">HORA IN√çCIO (CICLO)</th>
                        <th class="data-header">PONTO BASE ATUAL</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><select id="veiculo"><option value="">Carregando...</option></select></td>
                        <td>
                            <div class="agentes-container">
                                <div class="agente-row"><input type="radio" name="condutor" value="0" class="condutor-radio"><input type="text" class="agente-input" list="listaAgentes" placeholder="AGENTE 1"></div>
                                <div class="agente-row"><input type="radio" name="condutor" value="1" class="condutor-radio"><input type="text" class="agente-input" list="listaAgentes" placeholder="AGENTE 2"></div>
                                <div class="agente-row"><input type="radio" name="condutor" value="2" class="condutor-radio"><input type="text" class="agente-input" list="listaAgentes" placeholder="AGENTE 3"></div>
                                <div class="agente-row"><input type="radio" name="condutor" value="3" class="condutor-radio"><input type="text" class="agente-input" list="listaAgentes" placeholder="AGENTE 4"></div>
                                <div class="agente-row"><input type="radio" name="condutor" value="4" class="condutor-radio"><input type="text" class="agente-input" list="listaAgentes" placeholder="AGENTE 5"></div>
                            </div>
                            <datalist id="listaAgentes"></datalist>
                        </td>
                        
                        <td id="container-ht" style="min-width: 80px;"></td>
                        <td id="container-ase" style="min-width: 80px;"></td>

                        <td>
                            <select id="situacao">
                                <option value="ATENDIMENTO">ATENDIMENTO</option>
                                <option value="DESPACHO">DESPACHO</option>
                                <option value="INSPE√á√ÉO">INSPE√á√ÉO</option>
                                <option value="FISCALIZA√á√ÉO">FISCALIZA√á√ÉO</option>
                                <option value="ATENDIMENTO A OCORRENCIAS DE SINISTRO">ATENDIMENTO A OCORRENCIAS DE SINISTRO</option>
                            </select>
                        </td>
                        
                        <td><input type="text" id="maletas" class="campo-numerico" placeholder="N¬∫ MALETA" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></td>

                        <td>
                            <select id="zona">
                                <option value="">SELECIONE...</option>
                                <option value="REGI√ÉO 1">REGI√ÉO 1</option>
                                <option value="REGI√ÉO 2">REGI√ÉO 2</option>
                                <option value="REGI√ÉO 3">REGI√ÉO 3</option>
                                <option value="REGI√ÉO 4">REGI√ÉO 4</option>
                                <option value="REGI√ÉO 5">REGI√ÉO 5</option>
                                <option value="GERAL">GERAL</option>
                            </select>
                        </td>
                        <td><input type="time" id="horaInicio"></td>
                        <td><textarea id="pontoBase" class="obrigatorio" placeholder="CAMPO OBRIGAT√ìRIO"></textarea></td>
                    </tr>
                </tbody>
            </table>
            <div style="text-align: center;"><button type="submit" class="btn btn-salvar">Registrar Equipe</button></div>
        </form>
    </div>

    <div style="text-align: center; margin-top: 20px; gap: 10px; display: flex; justify-content: center; padding-bottom: 20px;">
        <button id="btnCSV" class="btn btn-download">Baixar Relat√≥rio CSV</button>
        <a href="index.html" class="btn btn-home">P√°gina Inicial</a>
        <a href="ocorrencias.html" class="btn btn-home">Ocorr√™ncias</a>
        <a href="observacoes.html" id="btnNavObservacoes" class="btn btn-home">Observa√ß√µes</a>
        <a href="relatorio_geral.html" id="btnNavRelatorios" class="btn btn-home" style="background-color: #8e44ad;">Relat√≥rio PDF</a>
    </div>

    <div class="section-title">‚ö†Ô∏è Ve√≠culos em Opera√ß√£o (Sincronizado)</div>
    <table id="tabelaAtivos">
        <tbody></tbody>
    </table>

    <div class="section-title">‚úÖ Hist√≥rico de Atividades Encerradas</div>
    <table id="relatorioFinal">
        <thead>
            <tr>
                <th>VE√çCULO</th>
                <th>AGENTE</th>
                <th>HT</th>
                <th>ASE</th>
                <th>FUN√á√ÉO</th>
                <th>MALETAS</th>
                <th>REGI√ÉO</th>
                <th>HORA IN√çCIO</th>
                <th>HORA FIM</th>
                <th>TIPO REGISTRO</th>
                <th>PONTO BASE</th>
                <th>A√á√ÉO</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, where, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // --- CONFIGURA√á√ÉO ---
    const firebaseConfig = {
        apiKey: "AIzaSyCjiEzdahcQqKS9V1Py4nAIx15Zqr9nIIo",
        authDomain: "sttu-registros.firebaseapp.com",
        projectId: "sttu-registros",
        storageBucket: "sttu-registros.firebasestorage.app",
        messagingSenderId: "785219239564",
        appId: "1:785219239564:web:4b8175a8d7ccceba06c5a9",
        measurementId: "G-C7PSE7YFRG"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let veiculosEmUso = new Set();
    let agentesEmUso = new Set();
    let nomeUsuarioLogado = "AN√îNIMO"; 
    let usuarioEhAdmin = false; 
    let isVisualizador = false;
    
    // Armazena os dados do hist√≥rico para renderizar novamente quando o login confirmar que √© admin
    let listaHistoricoCache = []; 

    // --- SEGURAN√áA + TIMER DE 30 MIN ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const docRef = doc(db, "usuarios", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    
                    // NOME
                    nomeUsuarioLogado = dados.nome || "Usu√°rio";
                    
                    // 1. DEFINE SE √â ADMIN
                    usuarioEhAdmin = (dados.cargo === 'admin'); 
                    
                    document.getElementById('nomeUsuarioDisplay').innerText = "Ol√°, " + nomeUsuarioLogado + (usuarioEhAdmin ? " (ADMIN)" : "");

                    // 2. FOR√áA A ATUALIZA√á√ÉO DA TABELA (Para aparecer o bot√£o de excluir)
                    renderizarTabelaHistorico();

                    // --- REGRA GERAL: S√ì ADMIN BAIXA CSV E V√ä PDF ---
                    if (dados.cargo !== 'admin') {
                        const btnCsv = document.getElementById('btnCSV');
                        if (btnCsv) btnCsv.style.display = 'none';

                        const btnRel = document.getElementById('btnNavRelatorios');
                        if (btnRel) btnRel.style.display = 'none';
                    }

                    // --- BLOQUEIO PARA VISUALIZADOR (ESTRAT√âGIA NUCLEAR) ---
                    if (dados.cargo === 'visualizador' || dados.nivel_acesso === 'leitura') {
                        isVisualizador = true;
                        console.log("üîí Modo Apenas Leitura Ativado");

                        // 1. DESTRUIR √ÅREA DE REGISTRO
                        const areaRegistro = document.getElementById('areaRegistro');
                        if (areaRegistro) areaRegistro.remove();

                        // 2. INJETAR CSS PARA ESCONDER A√á√ïES NA TABELA
                        const styleBlock = document.createElement('style');
                        styleBlock.innerHTML = `
                            .col-acao, .btn-acao-tabela, .btn-encaminhar, .btn-devolver, .btn-confirmar {
                                display: none !important;
                            }
                            table th:last-child, table td:last-child {
                                display: none !important;
                            }
                        `;
                        document.head.appendChild(styleBlock);

                        // 3. OCULTAR BOT√ïES DE NAVEGA√á√ÉO PROIBIDOS
                        const btnObs = document.getElementById('btnNavObservacoes');
                        if (btnObs) btnObs.style.display = 'none';
                        
                        window.devolverVeiculo = () => alert("Acesso Negado.");
                    } else {
                        isVisualizador = false;
                    }
                    
                    if (dados.cargo !== 'visualizador') {
                        let tempoInatividade;
                        const LIMITE_TEMPO = 30 * 60 * 1000; 
                        const resetarTimer = () => {
                            clearTimeout(tempoInatividade);
                            tempoInatividade = setTimeout(() => {
                                alert("‚ö†Ô∏è Sess√£o encerrada por inatividade (30min).");
                                signOut(auth).then(() => window.location.href = "login.html");
                            }, LIMITE_TEMPO);
                        };
                        window.onload = resetarTimer; document.onmousemove = resetarTimer; document.onkeypress = resetarTimer; document.onclick = resetarTimer; document.onscroll = resetarTimer;
                    }
                } else {
                    alert("Erro de cadastro. Contate o suporte.");
                    await signOut(auth);
                    window.location.href = "login.html";
                }
            } catch (error) { console.error("Erro:", error); }
        } else {
            window.location.href = "login.html";
        }
    });

    const btnSair = document.getElementById('btnSair');
    if(btnSair) {
        btnSair.onclick = () => {
            signOut(auth).then(() => { window.location.href = "login.html"; });
        }
    }

    const agentesDB = ["ADRIANA GOMES DA SILVA - 43.071-4", "ADRIANO ANDR√â GUEDES COSTA - 43.079-0", "ADRIANO NASCIMENTO DA FONSECA - 49.991-9", "AFR√ÇNIO MEDEIROS DA COSTA - 43.151-6", "AGRICIO BELCHIOR BANDEIRA NETO - 43.127-3", "AILTON ANDRADE - 62.095-5", "ALCINEIDE JUSTO SIQUEIRA - 62.100-5", "ALDREY LUIZ MORAIS DA SILVA - 62.549-3", "ALDRIN MAGNO DANTAS SIQUEIRA - 43.080-3", "ALESSANDRA DORA DA SILVA COSTA - 43.199-1", "ALEX SERAFIM DA SILVA - 15.231-5", "ALEXANDRA BARROS DO NASCIMENTO - 49.953-6", "ALEXANDRE DE SOUZA - 13.174-1", "ALEXANDRE MAGNO FREITAS COSMO - 61.947-7", "ALEXSANDRO NASCIMENTO BARBOSA - 43.072-2", "ALYENE PATRICIA CRUZ BRITO ALVES - 64.545-0", "ALISSON EMANOEL DE OLIVEIRA FAGUNDES - 49.995-1", "ALLAN ARA√öJO DE MEDEIROS - 43.073-1", "ANA MARIA DA SILVA ALVES - 13.141-5", "ANDERSON RODRIGO DO NASCIMENTO - 63.802-1", "ANDRE CORCINO DE LIMA FILHO - 00.387-5", "ANDREA CASTRO GALV√ÉO - 62.097-1", "ANDREIA CARLA SILVA FONSECA E SOUZA - 14.071-6", "ANDREZA CABRAL C√ÇMARA NUNES - 61.710-5", "ANNE CAROLINE MACEDO DE ARA√öJO - 60.233-7", "ANT√ÉO LOPES DE ARA√öJO FILHO - 43.100-1", "ANTONIO CLEMENTINO DA ROCHA - 13.632-8", "ANTONIO GUILHERME DOS SANTOS - 14.206-9", "ANTONIO SARMENTO RODRIGUES FILHO - 13.634-4", "BARBARA KALYANA DOS SANTOS GOMES - 43.102-8", "CARLOS EUBER DE FREITAS NEVES - 43.077-3", "CARLOS EUG√äNIO BARBOSA DE OLIVEIRA - 00.282-8", "CARLOS VALENTIM ALVES - 13.140-7", "CARLYLE C√ÇMARA DOS SANTOS - 43.150-8", "CARMOZINA REGIA DE MELO DANTAS - 43.084-6", "CAROLINA DE C√ÅSSIA DEFENTE - 43.101-0", "CASSIO CLAY PEREIRA - 14.190-9", "CASTRICIANO BRAZ DOS SANTOS - 13.593-3", "CHIARA LUCIA DE GUM√ÉO GON√áALVES COSTA - 43.096-0", "CLAUDIA JACQUELINE GALV√ÉO SOUZA - 14.937-3", "CLEIDE MARIA DOS SANTOS SILVA - 13.614-0", "CLEONEIDE CORREIA RAMALHO RIBEIRO - 13.609-3", "CRISTIANE DE MACEDO E SILVA - 62.873-5", "DANIEL ALBURQUERQUE EMERENCIANO GON√áALVES - 43.090-1", "DANIELLE PEREIRA DE OLIVEIRA - 60.072-5", "DANILSON BENTES MARINHO - 13.116-4", "DAVI FIRMINO DE LIMA - 14.953-5", "DEN√çLSON ARA√öJO DA COSTA - 60.090-3", "DIONISIO CARDOSO DA COSTA - 13.659-0", "DANILO CLAUDIO LIRA DOS SANTOS - 72.245-7", "ED√çLSON FERREIRA DOS SANTOS - 00.417-1", "EDILSON OLIVEIRA DA SILVA - 13.147-4", "EDINALVA DUARTE LEAL DE MEDEIROS - 00.463-4", "EDIN√ÅSIO COSTA SOARES - 49.986-2", "EDJA DE PAULA MAIA - 45.570-9", "EDSON RAIMUNDO DA SILVA - 13.463-5", "EDVALDO MANOEL DA SILVA - 00.465-1", "EDVALDO SOARES DA SILVA - 09.325-4", "ELIZABETE RANYELA MORAIS DE MOURA - 43.198-2", "ERNESTO MORAIS VIANA - 14.930-6", "EVALDO FELIX FERREIRA - 00.518-5", "EVERALDO ALEXANDRE FREIRE - 14.043-1", "FERNANDA FREITAS DE HOLANDA - 60.066-1", "FRANCISCO GILSON LEONIDAS DA SILVA - 13.679-4", "FRANZ BIAGGIO FULCO GAAG - 65.247-4", "GENALDO AZEVEDO TRINDADE - 43.086-2", "GILDIBERTO DE SOUZA ALVES - 08.646-1", "GILMAR GOMES DO NASCIMENTO - 06.726-1", "GUTEMBERG PEREIRA - 08.015-2", "HAILSON CABRAL DO NASCIMENTO - 00.375-1", "HARLLEY CAMPOS MARQUES - 65.420-5", "HEITOR RODRIGUES DE LIMA - 43.097-8", "HEMERSON MELO DA SILVA - 49.952-8", "HERANDY DE ARA√öJO CABRAL - 49.950-1", "HERQUILES LIMA DOS SANTOS - 43.149-4", "HEWERTON MOURA DA SILVA - 43.098-6", "ISABELA SILVA NIC√ÅCIO DE BRITO - 60.234-5", "ISRAEL FERREIRA PEREIRA - 13.110-5", "IVAN DE CARVALHO MEDEIROS - 00.431-6", "IVES SILVA DE SOUZA - 62.151-0", "JAIR JEFFERSON DE CARVALHO - 13.896-7", "JARDEL BEZERRA DE ANDRADE - 62.189-7", "JARDS MEDEIROS DE OLIVEIRA - 62.826-3", "JATSON FRANCISCO DA SILVA BANDEIRA - 13.727-8", "JEFFERSON STANLEY DA SILVA - 62.919-7", "JO√ÉO BATISTA MONTEIRO DE AQUINO - 00.482-1", "JO√ÉO BATISTA ROCHA FILHO - 49.994-3", "JO√ÉO BATISTA VARELA BARCA - 15.710-4", "JO√ÉO CLAUDIO OLIVEIRA DE FARIAS - 00.383-2", "JO√ÉO FERREIRA - 06.644-3", "JO√ÉO MARIA ALMEIDA DE MOURA - 43.070-6", "JO√ÉO MARIA MACEDO ROCHA - 43.201-6", "JO√ÉO PAULO DE OLIVEIRA - 43.082-0", "JO√ÉO WILLAMS DA SILVA - 62.253-2", "JONAS CRISTINO DA SILVA - 14.931-4", "JORGE LUIZ BARROS DO NASCIMENTO - 62.431-4", "JORGE LUIZ SIQUEIRA DE OLIVEIRA - 62.191-9", "JOS√â EUDES BEZERRA - 49.985-4", "JOS√â ALBERTO FREIRE DA COSTA - 42.766-7", "JOSE ALVES DE SOUZA NETO - 00.544-4", "JOSE AUTEMAR RICARDO - 00.475-8", "JOSE DINIZ RAMOS - 00.575-4", "JOSE EBER DA SILVA - 13.105-9", "JOS√â GON√áALVES MANGABEIRA DE MEDEIROS - 43.083-8", "JOS√â RICARDO GOMES CAVALCANTE - 13.102-4", "JOSE ROBERTO DA SILVA DE OLIVEIRA - 14.922-5", "JOS√â ROOSEVELT MEDEIROS J√öNIOR - 62.416-1", "JOSEMAR DA SILVA DAMASCENO - 60.068-7", "JOSEMAR TAVARES C√ÇMARA JUNIOR - 43.152-4", "JOSENILSON TEIXEIRA DE SOUZA - 00.386-7", "KASTEEN CARLOS DE AQUINO E SILVA - 43.076-5", "KLEBER SILVESTRE LUSTOSA - 49.825-4", "LAILTON RIBEIRO DA COSTA - 43.078-1", "LEONARDO BATISTA DE SOUZA SILVA - 64.542-7", "LEONARDO DA SILVEIRA LUCENA - 43.122-2", "MADSON LIMA CAVALCANTI DE OLIVEIRA - 49.989-7", "MANOEL NOBREGA DE OLIVEIRA - 13.758-8", "MARA LUCIA BARROS DE SOUZA - 70.665-5", "MARCELO BATISTA DE ANDRADE - 61.952-3", "MARCELO FRAN√áA DA SILVA - 60.073-3", "MARCELO ZAERDSON LINS MEDEIROS - 62.184-6", "MARCILIO DE OLIVEIRA RODRIGUES - 49.951-0", "M√ÅRCIO JOS√â DA SILVA - 68.159-8", "MARCOS ANTONIO DE OLIVEIRA - 07.326-1", "MARIA DE LOURDES DA SILVA FILHA - 43.200-8", "MARIA DO CARMO DA SILVA - 00.571-1", "MARIA DO SOCORRO LIMA MARTINS - 14.070-8", "MARIA DO SOCORRO SILVA DE ANDRADE - 14.114-3", "MARIA GORETE DUTRA DE OLIVEIRA - 13.988-2", "MARIA JANEIDE BEZERRA DA SILVA - 00.536-3", "MARIA SANTANA BORGES DA SILVA - 00.561-4", "MARIO JOSE DA SILVA LEMOS - 14.944-6", "MARISA GILVANEIDE BERTO - 00.538-0", "MARYANE CRISTINA LOPES PEREIRA - 43.112-5", "MAXIMIANO CAPIM DE MIRANDA - 13.462-7", "MAXWELL FERNANDES DA SILVA - 13.136-9", "MIGUEL √ÇNGELO DE SANTANA - 62.092-1", "MOISES PEREIRA DE ARAUJO - 08.229-5", "NADJANIA MARIA DAMASCENO VALLE - 62.368-7", "NAOMI SUASSUNA DOS SANTOS - 60.237-0", "NEUZELIDES PRISCILA SILVA ANDRADE - 49.949-8", "NEWDENBERG FERREIRA GALV√ÉO - 43.081-1", "NEWTON DE SOUZA PEREIRA FILHO - 60.064-4", "NUBIA SILENE DA SILVA COSTA - 14.109-7", "PATR√çCIA CRISTINA CAVALCANTE - 45.990-9", "RAIMUNDO NONATO DE MEDEIROS NETO - 00.249-6", "RAPHAELLE CAVALCANTE R. DE ARAUJO - 62.149-8", "RECIO RONALDO ANDRADE DE PAIVA - 09.532-0", "REGINA VIC√äNCIA CRISPIM - 62.250-8", "RICARDO SERGIO GOMES DA SILVA - 13.477-5", "RITA DE C√ÅSSIA SILVA - 49.992-7", "ROBSON LUIZ DE AZEVEDO - 00.184-8", "RODRIGO COSTA - 43.087-1", "ROGELIO FERNANDES DE MELO - 13.095-8", "RONALDO JORGE DA SILVA - 13.096-6", "RONALDO MARINHO DE SOUZA - 62.825-5", "RONALDO TEIXEIRA DE ARA√öJO - 62.257-5", "ROSEMBERG PEREIRA - 00.137-6", "SANDRA DA SILVA BEZERRIL BACELAR - 61.712-1", "SARAH POLYANA DIAS DOS SANTOS - 43.154-1", "SEVERINA SOARES NETA CARNEIRO - 00.327-1", "SEVERINO FERNANDES MAIA - 00.192-9", "SEVERINO SOLANO DA SILVA - 00.486-3", "SOLANO LOPES DANTAS - 00.663-7", "SYBELLE DE ARA√öJO DANTAS - 63.386-1", "TALITHA LOUISE FORTUNATO BEZERRA - 49.990-1", "THALES GALV√ÉO DE ARAUJO - 63.803-0", "THALLES THIAGO MEDEIROS DE SOUZA - 49.988-9", "THIAGO DE LIRA BEZERRA - 43.075-7", "THIAGO HENRIQUE FERREIRA DA SILVA - 60.275-2", "VALDELICE FERREIRA DE OLIVEIRA - 00.507-0", "VANESSA GALDINO DA SILVA - 61.955-8", "WALDICK GUERRA DE MEDEIROS - 13.281-1", "WALTER PEDRO DA SILVA - 00.358-1", "WANDERCLEY SILVA NEVES - 70.563-2", "WANDR√â WAGNER DA SILVA - 62.367-9", "ZELIO CUNHA - 13.400-7"];
    
    const form = document.getElementById('registroForm');
    const tabelaAtivos = document.getElementById('tabelaAtivos').getElementsByTagName('tbody')[0];
    const relatorioFinalTbody = document.getElementById('relatorioFinal').getElementsByTagName('tbody')[0];

    function atualizarDataEHora() {
        const dataAtual = new Date();
        const diasSemana = ['DOMINGO', 'SEGUNDA', 'TER√áA', 'QUARTA', 'QUINTA', 'SEXTA', 'S√ÅBADO'];
        const dia = String(dataAtual.getDate()).padStart(2, '0');
        const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
        const ano = dataAtual.getFullYear();
        document.getElementById('diaSemana').textContent = diasSemana[dataAtual.getDay()];
        document.getElementById('dataRelatorio').value = `${dia}/${mes}/${ano}`;
        return `${dia}/${mes}/${ano}`;
    }

    function obterClasseRegiao(zona) {
        if (!zona) return '';
        const z = zona.toUpperCase();
        if (z === 'REGI√ÉO 1') return 'regiao-1';
        if (z === 'REGI√ÉO 2') return 'regiao-2';
        if (z === 'REGI√ÉO 3') return 'regiao-3';
        if (z === 'REGI√ÉO 4') return 'regiao-4';
        if (z === 'REGI√ÉO 5') return 'regiao-5';
        if (z === 'GERAL') return 'regiao-geral';
        return '';
    }

    function carregarAgentes(agentesSelecionadosNoForm = []) {
        const dl = document.getElementById('listaAgentes');
        dl.innerHTML = "";
        
        const agentesFiltrados = agentesDB.filter(agente => 
            !agentesSelecionadosNoForm.includes(agente) && 
            !agentesEmUso.has(agente)
        );
        
        agentesFiltrados.sort().forEach(agente => {
            const opt = document.createElement('option');
            opt.value = agente;
            dl.appendChild(opt);
        });
    }

    function gerarCamposDinamicos() {
        const veiculo = document.getElementById('veiculo').value;
        const containerHT = document.getElementById('container-ht');
        const containerASE = document.getElementById('container-ase');

        let qtd = 1;
        // UMT tem 5 campos
        if (veiculo.startsWith('VT') || veiculo === 'GUINCHO' || veiculo === 'UMT') {
            qtd = 5;
        }

        containerHT.innerHTML = "";
        containerASE.innerHTML = "";

        for (let i = 0; i < qtd; i++) {
            let inputHT = document.createElement('input');
            inputHT.type = 'text'; 
            inputHT.className = 'campo-numerico only-numbers input-multiplo input-dinamico-ht';
            inputHT.placeholder = qtd > 1 ? `HT ${i+1}` : 'N¬∫ HT';
            inputHT.oninput = function() { this.value = this.value.replace(/[^0-9]/g, ''); };
            containerHT.appendChild(inputHT);

            let inputASE = document.createElement('input');
            inputASE.type = 'text'; 
            inputASE.className = 'campo-numerico only-numbers input-multiplo input-dinamico-ase';
            inputASE.placeholder = qtd > 1 ? `ASE ${i+1}` : 'N¬∫ ASE';
            // PERMITINDO V√çRGULA
            inputASE.oninput = function() { this.value = this.value.replace(/[^0-9,]/g, ''); };
            containerASE.appendChild(inputASE);
        }
    }

    function atualizarOpcoesDisponiveis() {
        const inputs = document.querySelectorAll('.agente-input');
        const selecionados = [];
        inputs.forEach(input => {
            const val = input.value.trim().toUpperCase();
            if (val !== "") selecionados.push(val);
        });
        carregarAgentes(selecionados);
    }

    function verificarLimiteAgentes() {
        const veiculo = document.getElementById('veiculo').value;
        const rows = document.querySelectorAll('.agente-row');
        const locaisFixos = ["PONTO FIXO", "COTT", "CIOSP", "BASE MIDWAY", "GUINCHO"];
        
        // UMT permite m√∫ltiplos agentes, ent√£o N√ÉO entra em 'apenasUmAgente'
        const apenasUmAgente = veiculo.startsWith("MT") || locaisFixos.includes(veiculo);
        
        // UMT desabilita condutor
        const semCondutorNecessario = ["PONTO FIXO", "COTT", "CIOSP", "BASE MIDWAY", "UMT"].includes(veiculo);

        rows.forEach((row, index) => {
            const input = row.querySelector('.agente-input');
            const radio = row.querySelector('.condutor-radio');
            if (index > 0) {
                if (apenasUmAgente) {
                    input.value = ""; input.disabled = true;
                    radio.disabled = true; radio.checked = false;
                    row.style.opacity = "0.3";
                } else {
                    input.disabled = false; radio.disabled = false;
                    row.style.opacity = "1";
                }
            } else {
                if (semCondutorNecessario) {
                    radio.checked = false; radio.disabled = true;
                } else if (apenasUmAgente) {
                    radio.checked = true; radio.disabled = false;
                } else {
                    radio.disabled = false;
                }
            }
        });
        atualizarOpcoesDisponiveis();
        gerarCamposDinamicos();
    }

    function gerarListaVeiculos() {
        const select = document.getElementById('veiculo');
        select.innerHTML = '<option value="">Selecione...</option>';
        const grupoMT = document.createElement('optgroup'); grupoMT.label = "MOTOS (MT)";
        for (let i = 1; i <= 80; i++) {
            let n = i < 10 ? '0' + i : i;
            grupoMT.appendChild(new Option('MT ' + n, 'MT ' + n));
        }
        select.appendChild(grupoMT);
        const grupoVT = document.createElement('optgroup'); grupoVT.label = "VIATURAS (VT)";
        for (let i = 1; i <= 16; i++) {
            let n = i < 10 ? '0' + i : i;
            grupoVT.appendChild(new Option('VT ' + n, 'VT ' + n));
        }
        select.appendChild(grupoVT);
        const gO = document.createElement('optgroup'); gO.label = "OUTROS";
        gO.appendChild(new Option('UMT', 'UMT')); 
        gO.appendChild(new Option('GUINCHO', 'GUINCHO'));
        gO.appendChild(new Option('PONTO FIXO', 'PONTO FIXO'));
        gO.appendChild(new Option('COTT', 'COTT'));
        gO.appendChild(new Option('CIOSP', 'CIOSP'));
        gO.appendChild(new Option('BASE MIDWAY', 'BASE MIDWAY'));
        select.appendChild(gO);
    }

    // --- FIREBASE OPS ---
    const qAtivos = query(collection(db, "ativos_agentes"), orderBy("timestamp", "asc"));
    onSnapshot(qAtivos, (snapshot) => {
        tabelaAtivos.innerHTML = ""; 
        veiculosEmUso.clear(); 
        agentesEmUso.clear(); 

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            data.id = docSnap.id; 
            adicionarLinha(tabelaAtivos, data, true);
            veiculosEmUso.add(data.veiculo);
            
            if (data.agente) {
                const linhas = data.agente.split('\n');
                linhas.forEach(linha => {
                    let nomeLimpo = linha.replace(' (C)', '').trim();
                    if(nomeLimpo) agentesEmUso.add(nomeLimpo);
                });
            }
        });
        carregarAgentes(); 
    });

    const dataHoje = atualizarDataEHora(); 
    
    // VARI√ÅVEL GLOBAL PARA ARMAZENAR DADOS DO HIST√ìRICO
    let listaHistoricoGlobal = [];

    const qHistorico = query(
        collection(db, "historico_agentes"), 
        where("dataRelatorio", "==", dataHoje)
    );

    onSnapshot(qHistorico, (snapshot) => {
        listaHistoricoGlobal = [];
        snapshot.forEach((docSnap) => {
            listaHistoricoGlobal.push({ id: docSnap.id, ...docSnap.data() });
        });
        
        // Renderiza a tabela (agora segura, pois usa a vari√°vel global e admin j√° definido)
        renderizarTabelaHistorico();
    });

    function renderizarTabelaHistorico() {
        relatorioFinalTbody.innerHTML = "";
        
        // Ordena por timestamp
        listaHistoricoGlobal.sort((a, b) => {
            const tA = a.timestamp ? a.timestamp.seconds : 0;
            const tB = b.timestamp ? b.timestamp.seconds : 0;
            return tA - tB;
        });

        listaHistoricoGlobal.forEach((data) => {
            adicionarAoRelatorioVisual(data, data.horaFim, data.tipo);
        });
    }

    async function salvarNoFirebase(colecao, dados) {
        try {
            await addDoc(collection(db, colecao), {
                ...dados,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            alert("Erro ao salvar no banco de dados.");
            console.error(e);
        }
    }

    async function devolverVeiculo(dados, horaFim) {
        const dadosHistorico = {...dados, horaFim, tipo: 'ENCERRAMENTO'};
        delete dadosHistorico.id; 
        delete dadosHistorico.timestamp; 
        try {
            await addDoc(collection(db, "historico_agentes"), { ...dadosHistorico, timestamp: serverTimestamp() });
            await deleteDoc(doc(db, "ativos_agentes", dados.id));
            
            // --- LOG DE AUDITORIA ---
            registrarLogAuditoria("DEVOLU√á√ÉO VE√çCULO", `Ve√≠culo: ${dados.veiculo} devolvido por ${nomeUsuarioLogado}.`);

        } catch (e) { alert("Erro ao devolver: " + e.message); }
    }

    function adicionarAoRelatorioVisual(dados, horaFim, tipoRegistro) {
        const row = relatorioFinalTbody.insertRow();
        const chaves = ['veiculo', 'agente', 'ht', 'ase', 'situacao', 'maletas', 'zona', 'horaInicio', 'horaFim', 'tipo', 'pontoBase'];
        let dadosDisplay = {...dados};
        if(horaFim) dadosDisplay.horaFim = horaFim;
        if(tipoRegistro) dadosDisplay.tipo = tipoRegistro;
        
        chaves.forEach(key => {
            const cell = row.insertCell();
            let conteudo = (String(dadosDisplay[key]) || "").replace(/\n/g, '<br>');
            
            if (key === 'zona') {
                cell.className = obterClasseRegiao(dadosDisplay[key]);
            }

            if (key === 'agente') conteudo = conteudo.replace(/\(C\)/g, '<b class="condutor-destaque"> [CONDUTOR]</b>');
            if (key === 'horaFim') cell.className = 'hora-fim-celula';
            if (key === 'tipo') cell.className = dadosDisplay.tipo === 'ENCAMINHAMENTO' ? 'status-encaminhado' : 'status-encerrado';
            cell.innerHTML = conteudo;
        });

        // --- COLUNA DE A√á√ÉO (EXCLUIR) ---
        const cellAcao = row.insertCell();
        
        if (usuarioEhAdmin) {
            const btnExcluir = document.createElement('button');
            btnExcluir.innerHTML = '&#10006;'; // X Symbol
            btnExcluir.className = 'btn-excluir-x';
            btnExcluir.title = "Excluir registro permanentemente";
            btnExcluir.onclick = function() {
                excluirItemHistorico(dados.id);
            };
            cellAcao.appendChild(btnExcluir);
        }
    }

    async function excluirItemHistorico(id) {
        if (!usuarioEhAdmin) return;
        
        if (confirm("ATEN√á√ÉO ADMIN:\n\nDeseja realmente excluir este registro do hist√≥rico permanentemente?")) {
            try {
                await deleteDoc(doc(db, "historico_agentes", id));
                registrarLogAuditoria("EXCLUS√ÉO HIST√ìRICO", `Registro ID ${id} exclu√≠do por ${nomeUsuarioLogado}.`);
                alert("Registro exclu√≠do.");
            } catch (e) {
                alert("Erro ao excluir: " + e.message);
            }
        }
    }

    function adicionarLinha(tabela, dados, ativo) {
        const row = tabela.insertRow();
        const chaves = ['veiculo', 'agente', 'ht', 'ase', 'situacao', 'maletas', 'zona', 'horaInicio', 'pontoBase'];
        const cellsMap = {};

        chaves.forEach(key => {
            const cell = row.insertCell();
            cellsMap[key] = cell;
            let conteudo = (String(dados[key]) || "").replace(/\n/g, '<br>');
            
            if (key === 'zona') {
                cell.className = obterClasseRegiao(dados[key]);
            }

            if(key === 'agente') conteudo = conteudo.replace(/\(C\)/g, '<b class="condutor-destaque"> [CONDUTOR]</b>');
            cell.innerHTML = conteudo;
        });

        if (ativo) {
            const actionCell = row.insertCell();
            
            // --- AQUI VEM O BLOQUEIO: S√≥ cria bot√µes se N√ÉO for visualizador
            if (!isVisualizador) {
                const btnDevolver = document.createElement('button');
                btnDevolver.innerHTML = 'DEVOLVER'; 
                btnDevolver.className = 'btn btn-devolver';
                btnDevolver.onclick = function() {
                    if(confirm(`Devolver ${dados.veiculo}?`)) {
                        const agora = new Date();
                        const horaFim = String(agora.getHours()).padStart(2,'0') + ":" + String(agora.getMinutes()).padStart(2,'0');
                        devolverVeiculo(dados, horaFim);
                    }
                };
                actionCell.appendChild(btnDevolver);

                if (dados.veiculo.startsWith('MT') || dados.veiculo.startsWith('VT') || dados.veiculo === 'UMT') {
                    const btnEncaminhar = document.createElement('button');
                    btnEncaminhar.innerHTML = 'ENCAMINHAR';
                    btnEncaminhar.className = 'btn btn-encaminhar';
                    
                    // --- L√ìGICA DE EDI√á√ÉO/ENCAMINHAR ---
                    btnEncaminhar.onclick = async function() {
                        const editaveis = ['situacao', 'maletas', 'pontoBase', 'ht', 'ase'];
                        
                        if (btnEncaminhar.innerHTML === 'ENCAMINHAR') {
                            editaveis.forEach(key => { 
                                cellsMap[key].contentEditable = "true"; 
                                cellsMap[key].classList.add('editando-celula'); 
                            });
                            
                            // L√ìGICA DO DROPDOWN DA ZONA
                            const zonaAtual = cellsMap['zona'].innerText.trim();
                            cellsMap['zona'].className = ''; 
                            cellsMap['zona'].innerHTML = `<select class="edit-zona">
                                <option value="REGI√ÉO 1" ${zonaAtual==='REGI√ÉO 1'?'selected':''}>REGI√ÉO 1</option>
                                <option value="REGI√ÉO 2" ${zonaAtual==='REGI√ÉO 2'?'selected':''}>REGI√ÉO 2</option>
                                <option value="REGI√ÉO 3" ${zonaAtual==='REGI√ÉO 3'?'selected':''}>REGI√ÉO 3</option>
                                <option value="REGI√ÉO 4" ${zonaAtual==='REGI√ÉO 4'?'selected':''}>REGI√ÉO 4</option>
                                <option value="REGI√ÉO 5" ${zonaAtual==='REGI√ÉO 5'?'selected':''}>REGI√ÉO 5</option>
                                <option value="GERAL" ${zonaAtual==='GERAL'?'selected':''}>GERAL</option>
                            </select>`;

                            // L√ìGICA DOS AGENTES (RADIOS)
                            const agentesAtuaisRaw = cellsMap['agente'].innerText.split('\n');
                            cellsMap['agente'].innerHTML = '';
                            cellsMap['agente'].classList.add('editando-celula');
                            
                            for(let i=0; i<5; i++) {
                                const linha = agentesAtuaisRaw[i] || "";
                                const isCond = linha.includes('[CONDUTOR]');
                                const nome = linha.replace(' [CONDUTOR]', '').trim();
                                
                                const div = document.createElement('div');
                                div.className = 'edit-row-container';
                                div.innerHTML = `
                                    <input type="radio" name="editCondutor_${dados.id}" class="condutor-radio" ${isCond?'checked':''}>
                                    <input type="text" class="edit-agente-input" list="listaAgentes" value="${nome}">
                                `;
                                cellsMap['agente'].appendChild(div);
                            }

                            btnEncaminhar.innerHTML = 'SALVAR';
                            btnEncaminhar.className = 'btn btn-confirmar';

                        } else {
                            // SALVAR NO BANCO
                            const inputsEdit = cellsMap['agente'].querySelectorAll('.edit-agente-input');
                            const radiosEdit = cellsMap['agente'].querySelectorAll(`input[name="editCondutor_${dados.id}"]`);
                            
                            let novaLista = [];
                            let condutorSelecionado = false;

                            inputsEdit.forEach((inp, idx) => {
                                let nome = inp.value.trim().toUpperCase();
                                if(nome !== "") {
                                    if(radiosEdit[idx].checked) {
                                        nome += " (C)";
                                        condutorSelecionado = true;
                                    }
                                    novaLista.push(nome);
                                }
                            });

                            if(novaLista.length === 0) { alert("A equipe n√£o pode ficar vazia."); return; }
                            
                            // UMT TAMB√âM N√ÉO EXIGE CONDUTOR NO EDIT
                            const semCondutor = ["PONTO FIXO", "COTT", "CIOSP", "BASE MIDWAY", "UMT"].includes(dados.veiculo);
                            if(!semCondutor && !condutorSelecionado) { 
                                alert("Selecione quem √© o CONDUTOR (‚¶ø) da equipe antes de salvar."); return; 
                            }

                            const agora = new Date();
                            const horaCorte = String(agora.getHours()).padStart(2,'0') + ":" + String(agora.getMinutes()).padStart(2,'0');

                            // Hist√≥rico do estado anterior
                            const histEnc = {...dados};
                            delete histEnc.id; delete histEnc.timestamp;
                            histEnc.horaFim = horaCorte;
                            histEnc.tipo = 'ENCAMINHAMENTO';
                            await addDoc(collection(db, "historico_agentes"), { ...histEnc, timestamp: serverTimestamp() });

                            const novaZona = cellsMap['zona'].querySelector('select').value;
                            
                            const detalhesLog = `Ve√≠culo: ${dados.veiculo} editado/encaminhado por ${nomeUsuarioLogado}. Zona: ${novaZona}. HT/ASE Atualizados.`;

                            // ATUALIZA√á√ÉO NO BANCO (INCLUINDO HT E ASE)
                            await updateDoc(doc(db, "ativos_agentes", dados.id), {
                                zona: novaZona,
                                horaInicio: horaCorte,
                                agente: novaLista.join('\n'),
                                situacao: cellsMap['situacao'].innerText.trim().toUpperCase(),
                                maletas: cellsMap['maletas'].innerText.trim().toUpperCase(),
                                pontoBase: cellsMap['pontoBase'].innerText.trim().toUpperCase(),
                                ht: cellsMap['ht'].innerText.trim().toUpperCase(),   // <--- HT EDITADO
                                ase: cellsMap['ase'].innerText.trim().toUpperCase()  // <--- ASE EDITADO
                            });

                            registrarLogAuditoria("ENCAMINHAR/EDITAR", detalhesLog);
                        }
                    };
                    // -------------------------------------------------------

                    actionCell.appendChild(btnEncaminhar);
                }
            }
        }
    }

    // Envolver o event listener em uma condicional para evitar erro se o formul√°rio for removido
    const elForm = document.getElementById('registroForm');
    if (elForm) {
        elForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const v = document.getElementById('veiculo').value;
            const z = document.getElementById('zona').value;
            const pb = document.getElementById('pontoBase').value.trim();
            const maletasVal = document.getElementById('maletas').value.trim();
            const condutorIndex = document.querySelector('input[name="condutor"]:checked')?.value;
            const inputsAgentes = document.querySelectorAll('.agente-input');
            
            let listaSelecionada = [];
            inputsAgentes.forEach((input, index) => {
                if (input.disabled) return;
                const val = input.value.trim().toUpperCase();
                if(val !== "") {
                    listaSelecionada.push(condutorIndex !== undefined && index == condutorIndex ? `${val} (C)` : val);
                }
            });

            for (let nome of listaSelecionada) {
                let nomeLimpo = nome.replace(' (C)', '').trim();
                if (agentesEmUso.has(nomeLimpo)) {
                    alert(`ERRO: O agente ${nomeLimpo} j√° est√° em outra viatura ativa! Devolva a viatura anterior primeiro.`);
                    return;
                }
            }

            const inputsHT = document.querySelectorAll('.input-dinamico-ht');
            const valoresHT = Array.from(inputsHT).map(i => i.value).filter(v => v).join('\n');

            const inputsASE = document.querySelectorAll('.input-dinamico-ase');
            const valoresASE = Array.from(inputsASE).map(i => i.value).filter(v => v).join('\n');

            if (!v || listaSelecionada.length === 0 || !z || !pb) { alert("Preencha campos obrigat√≥rios."); return; }
            if (!["PONTO FIXO", "COTT", "CIOSP", "BASE MIDWAY", "UMT"].includes(v) && veiculosEmUso.has(v)) { alert("Ve√≠culo em uso."); return; }
            
            // UMT TAMB√âM N√ÉO PRECISA DE CONDUTOR NO SUBMIT
            if (!["PONTO FIXO", "COTT", "CIOSP", "BASE MIDWAY", "UMT"].includes(v) && condutorIndex === undefined) { alert("Selecione o condutor (‚¶ø)."); return; }

            const dados = {
                veiculo: v,
                agente: listaSelecionada.join('\n'),
                situacao: document.getElementById('situacao').value,
                ht: valoresHT,
                zona: z,
                horaInicio: document.getElementById('horaInicio').value,
                ase: valoresASE,
                maletas: maletasVal.toUpperCase(),
                pontoBase: pb.toUpperCase(),
                dataRelatorio: document.getElementById('dataRelatorio').value
            };

            salvarNoFirebase("ativos_agentes", dados); 
            
            // --- LOG DE AUDITORIA ---
            registrarLogAuditoria("REGISTRAR EQUIPE", `Ve√≠culo: ${v} - Agentes: ${listaSelecionada.join(', ')} - Registrado por: ${nomeUsuarioLogado}`);

            document.getElementById('veiculo').value = "";
            document.querySelectorAll('.agente-input').forEach(i => i.value = "");
            document.getElementById('pontoBase').value = "";
            document.getElementById('maletas').value = "";
            verificarLimiteAgentes();
        });
    }

    document.getElementById('btnCSV').onclick = () => {
        let csv = ["\ufeffVE√çCULO,AGENTE,HT,ASE,FUN√á√ÉO,MALETAS,REGI√ÉO,HORA IN√çCIO,HORA FIM,TIPO,PONTO BASE"];
        
        const tableHistorico = document.getElementById('relatorioFinal');
        for (let i = 1; i < tableHistorico.rows.length; i++) {
            let row = [];
            const cells = tableHistorico.rows[i].cells;
            for (let j = 0; j < cells.length; j++) {
                let data = cells[j].innerText.replace(/"/g, '""').replace(/\n/g, ' ');
                row.push(`"${data}"`);
            }
            csv.push(row.join(","));
        }

        const rowsAtivos = tabelaAtivos.rows; 
        
        for (let i = 0; i < rowsAtivos.length; i++) {
             const cells = rowsAtivos[i].cells;
             if(cells.length < 9) continue; 

             let veiculo = cells[0].innerText;
             let agente = cells[1].innerText;
             let ht = cells[2].innerText;
             let ase = cells[3].innerText;
             let funcao = cells[4].innerText;
             let maletas = cells[5].innerText;
             let zona = cells[6].innerText;
             let inicio = cells[7].innerText;
             let fim = "EM ANDAMENTO"; 
             let tipo = "ATIVO";       
             let base = cells[8].innerText;

             let row = [
                 `"${veiculo.replace(/\n/g, ' ')}"`,
                 `"${agente.replace(/\n/g, ' ')}"`,
                 `"${ht.replace(/\n/g, ' ')}"`,
                 `"${ase.replace(/\n/g, ' ')}"`,
                 `"${funcao}"`,
                 `"${maletas.replace(/\n/g, ' ')}"`,
                 `"${zona}"`,
                 `"${inicio}"`,
                 `"${fim}"`,
                 `"${tipo}"`,
                 `"${base.replace(/\n/g, ' ')}"`
             ];
             csv.push(row.join(","));
        }

        const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `relatorio_geral_${document.getElementById('dataRelatorio').value.replace(/\//g, '-')}.csv`;
        link.click();
    };

    window.onload = () => {
        atualizarDataEHora();
        gerarListaVeiculos();
        carregarAgentes();
        const tableHead = document.getElementById('tabelaAtivos').createTHead();
        const headerOriginalRow = document.getElementById('headerOriginalRow');
        const newHeaderRow = document.createElement('tr');
        Array.from(headerOriginalRow.children).forEach(th => {
            const newTh = document.createElement('th');
            newTh.innerHTML = th.innerHTML;
            newTh.className = th.className;
            newHeaderRow.appendChild(newTh);
        });
        const thAcao = document.createElement('th');
        thAcao.className = 'data-header';
        thAcao.innerText = 'A√á√ÉO';
        newHeaderRow.appendChild(thAcao);
        tableHead.appendChild(newHeaderRow);
        document.getElementById('veiculo').onchange = verificarLimiteAgentes;
        document.querySelectorAll('.agente-input').forEach(i => { i.oninput = atualizarOpcoesDisponiveis; });
        
        gerarCamposDinamicos();
    };

    // --- FUN√á√ÉO DE AUDITORIA (ADICIONE NO FINAL DO SCRIPT) ---
    async function registrarLogAuditoria(acao, detalhes) {
        if (isVisualizador) return;
        try {
            await addDoc(collection(db, "logs_auditoria"), {
                usuario: nomeUsuarioLogado || "DESCONHECIDO",
                acao: acao.toUpperCase(),
                detalhes: detalhes,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Erro ao gerar log:", e);
        }
    }
</script>
</body>
</html>

